<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8">
<title>Ù…Ø¯ÛŒØ±ÛŒØª Ø§Ù‚Ø³Ø§Ø· Ø±ÙˆØ²Ø§Ù†Ù‡</title>
<style>
  body {
    font-family: sans-serif;
    max-width: 900px;
    margin: auto;
    padding: 20px;
    direction: rtl;
    background: #f9fafb;
  }
  h1 { text-align: center; color: #333; }
  table { width: 100%; border-collapse: collapse; margin-top: 10px; }
  th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
  th { background: #f3f4f6; }
  .done { background: #c8e6c9; text-decoration: line-through; }
  button { padding: 5px 10px; border: none; background: #007bff; color: #fff; border-radius: 5px; cursor: pointer; }
  button:hover { background: #0056b3; }
  input, select { padding: 6px; margin: 3px; border-radius: 5px; border: 1px solid #ccc; }
  #progressBarContainer {
    width: 100%;
    background: #e0e0e0;
    border-radius: 10px;
    overflow: hidden;
    margin-top: 10px;
  }
  #progressBar {
    height: 20px;
    width: 0%;
    background: linear-gradient(90deg, #4caf50, #81c784);
    text-align: center;
    color: white;
    line-height: 20px;
    font-size: 12px;
  }
</style>
</head>
<body>

<h1>Ù…Ø¯ÛŒØ±ÛŒØª Ø§Ù‚Ø³Ø§Ø· Ùˆ Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒÙ‡Ø§</h1>

<form id="loanForm">
  <input type="text" id="loanName" placeholder="Ù†Ø§Ù… Ù‚Ø³Ø·" required>
  <input type="number" id="loanAmount" placeholder="Ù…Ø¨Ù„Øº Ù‡Ø± Ù‚Ø³Ø· (ØªÙˆÙ…Ø§Ù†)" required>
  <input type="number" id="loanMonths" placeholder="ØªØ¹Ø¯Ø§Ø¯ Ø§Ù‚Ø³Ø§Ø·" required>
  <button type="submit">â• Ø§ÙØ²ÙˆØ¯Ù† Ù‚Ø³Ø·</button>
</form>

<div id="progressBarContainer">
  <div id="progressBar">0%</div>
</div>

<table id="loanTable">
  <thead>
    <tr>
      <th>Ù†Ø§Ù… Ù‚Ø³Ø·</th>
      <th>Ù…Ø¨Ù„Øº Ù…Ø§Ù‡Ø§Ù†Ù‡</th>
      <th>ØªØ§Ø±ÛŒØ®â€ŒÙ‡Ø§</th>
      <th>Ø¹Ù…Ù„ÛŒØ§Øª</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
// ØªØ¨Ø¯ÛŒÙ„ ØªØ§Ø±ÛŒØ® Ù…ÛŒÙ„Ø§Ø¯ÛŒ Ø¨Ù‡ Ø´Ù…Ø³ÛŒ
function getTodayPersianDate() {
  const today = new Date();
  const formatter = new Intl.DateTimeFormat('fa-IR', { year:'numeric', month:'2-digit', day:'2-digit' });
  const parts = formatter.formatToParts(today);
  const y = parts.find(p => p.type === 'year').value;
  const m = parts.find(p => p.type === 'month').value;
  const d = parts.find(p => p.type === 'day').value;
  return { year: +y, month: +m, day: +d, displayDate: `${y}/${m}/${d}` };
}

// ÙØ±Ù…Øª Ø¹Ø¯Ø¯
function formatNumber(n) {
  return new Intl.NumberFormat('fa-IR').format(n);
}

// Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§Ø² localStorage
let loans = JSON.parse(localStorage.getItem('loans') || '[]');

// Ø°Ø®ÛŒØ±Ù‡
function saveLoans() {
  localStorage.setItem('loans', JSON.stringify(loans));
  renderLoans();
  updateProgress();
}

// Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ù‚Ø³Ø· Ø¬Ø¯ÛŒØ¯
document.getElementById('loanForm').addEventListener('submit', e => {
  e.preventDefault();
  const name = document.getElementById('loanName').value.trim();
  const amount = parseInt(document.getElementById('loanAmount').value);
  const months = parseInt(document.getElementById('loanMonths').value);
  if (!name || !amount || !months) return;

  const today = getTodayPersianDate();
  const dates = [];
  for (let i = 0; i < months; i++) {
    dates.push({
      year: today.year,
      month: today.month + i,
      day: today.day,
      displayDate: `${today.year}/${String(today.month + i).padStart(2,'0')}/${String(today.day).padStart(2,'0')}`,
      isPaid: false
    });
  }

  loans.push({ name, monthlyAmount: amount, dates });
  saveLoans();
  e.target.reset();
});

// Ø­Ø°Ù Ù‚Ø³Ø·
function deleteLoan(index) {
  if (confirm("Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† Ù‚Ø³Ø· Ù…Ø·Ù…Ø¦Ù†ÛŒØŸ")) {
    loans.splice(index, 1);
    saveLoans();
  }
}

// ØªØºÛŒÛŒØ± ÙˆØ¶Ø¹ÛŒØª Ù¾Ø±Ø¯Ø§Ø®Øª
function togglePaid(loanIndex, dateIndex) {
  loans[loanIndex].dates[dateIndex].isPaid = !loans[loanIndex].dates[dateIndex].isPaid;
  saveLoans();
}

// Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù†ÙˆØ§Ø± Ù¾ÛŒØ´Ø±ÙØª
function updateProgress() {
  const total = loans.reduce((sum, l) => sum + l.dates.length, 0);
  const paid = loans.reduce((sum, l) => sum + l.dates.filter(d => d.isPaid).length, 0);
  const percent = total ? Math.round((paid / total) * 100) : 0;
  const bar = document.getElementById('progressBar');
  bar.style.width = percent + '%';
  bar.textContent = percent + '%';
}

// Ø±Ù†Ø¯Ø± Ø¬Ø¯ÙˆÙ„
function renderLoans() {
  const tbody = document.querySelector('#loanTable tbody');
  tbody.innerHTML = '';
  loans.forEach((loan, i) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${loan.name}</td>
      <td>${formatNumber(loan.monthlyAmount)}</td>
      <td>
        ${loan.dates.map((d, j) => `
          <button onclick="togglePaid(${i},${j})" style="background:${d.isPaid ? '#4caf50':'#ccc'}">
            ${d.displayDate}
          </button>
        `).join(' ')}
      </td>
      <td><button onclick="deleteLoan(${i})" style="background:#f44336">ğŸ—‘ Ø­Ø°Ù</button></td>
    `;
    tbody.appendChild(tr);
  });
}

// --- ÛŒØ§Ø¯Ø¢ÙˆØ± Ø§Ù‚Ø³Ø§Ø· Ù†Ø²Ø¯ÛŒÚ© (Reminder) ---
function checkReminders() {
  const today = getTodayPersianDate();
  let reminders = [];

  loans.forEach(loan => {
    loan.dates.forEach(date => {
      if (!date.isPaid) {
        const isToday = date.displayDate === today.displayDate;
        const isTomorrow =
          date.year === today.year &&
          date.month === today.month &&
          date.day === today.day + 1;

        if (isToday || isTomorrow) {
          reminders.push({
            name: loan.name,
            date: date.displayDate,
            amount: formatNumber(loan.monthlyAmount),
            when: isToday ? "Ø§Ù…Ø±ÙˆØ²" : "ÙØ±Ø¯Ø§"
          });
        }
      }
    });
  });

  if (reminders.length > 0) {
    const message = reminders
      .map(r => `ğŸ“… ${r.name} (${r.when} - ${r.date})\nğŸ’° Ù…Ø¨Ù„Øº: ${r.amount} ØªÙˆÙ…Ø§Ù†`)
      .join("\n\n");
    showReminderNotification(message);
  }
}

// Ù†Ù…Ø§ÛŒØ´ Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† Ù…Ø±ÙˆØ±Ú¯Ø± ÛŒØ§ Ù¾Ø§Ù¾â€ŒØ¢Ù¾
function showReminderNotification(message) {
  if ("Notification" in window) {
    if (Notification.permission === "granted") {
      new Notification("ÛŒØ§Ø¯Ø¢ÙˆØ± Ø§Ù‚Ø³Ø§Ø·", {
        body: message,
        icon: "https://cdn-icons-png.flaticon.com/512/3062/3062634.png",
      });
    } else if (Notification.permission !== "denied") {
      Notification.requestPermission().then(permission => {
        if (permission === "granted") {
          new Notification("ÛŒØ§Ø¯Ø¢ÙˆØ± Ø§Ù‚Ø³Ø§Ø·", {
            body: message,
            icon: "https://cdn-icons-png.flaticon.com/512/3062/3062634.png",
          });
        } else {
          alert("ğŸ”” ÛŒØ§Ø¯Ø¢ÙˆØ± Ø§Ù‚Ø³Ø§Ø·:\n\n" + message);
        }
      });
    } else {
      alert("ğŸ”” ÛŒØ§Ø¯Ø¢ÙˆØ± Ø§Ù‚Ø³Ø§Ø·:\n\n" + message);
    }
  } else {
    alert("ğŸ”” ÛŒØ§Ø¯Ø¢ÙˆØ± Ø§Ù‚Ø³Ø§Ø·:\n\n" + message);
  }
}

// Ø´Ø±ÙˆØ¹
document.addEventListener("DOMContentLoaded", function () {
  renderLoans();
  updateProgress();
  checkReminders();
  setInterval(checkReminders, 6 * 60 * 60 * 1000); // Ù‡Ø± Û¶ Ø³Ø§Ø¹Øª
});
</script>

</body>
</html>
