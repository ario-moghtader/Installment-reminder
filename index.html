<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø¯ÛŒØ±ÛŒØª Ø§Ù‚Ø³Ø§Ø· - Ø¢Ø±ÛŒÙˆ Ù…Ù‚ØªØ¯Ø±</title>
    <style>
        * { margin:0; padding:0; box-sizing:border-box; font-family:'Vazir',Tahoma,sans-serif;}
        body { background: linear-gradient(135deg,#667eea 0%,#764ba2 100%); color:#333; min-height:100vh; padding:20px; direction:rtl;}
        .container { max-width:1000px; margin:0 auto;}
        header { text-align:center; margin-bottom:30px; color:white; text-shadow:0 2px 5px rgba(0,0,0,0.3);}
        h1 { font-size:2.5rem; margin-bottom:10px;}
        .creator { font-size:1rem; opacity:0.9; margin-top:10px;}
        .main-card { background:white; border-radius:20px; padding:30px; box-shadow:0 15px 35px rgba(0,0,0,0.2); margin-bottom:20px;}
        .add-installment-form { display:grid; grid-template-columns:1fr 1fr 1fr 1fr 1fr 1fr auto; gap:12px; margin-bottom:30px; padding:25px; background:#f8f9fa; border-radius:15px;}
        @media(max-width:768px){.add-installment-form{grid-template-columns:1fr;}}
        .form-input { padding:12px 15px; border:2px solid #e9ecef; border-radius:10px; font-size:14px; transition:all 0.3s;}
        .form-input:focus { outline:none; border-color:#4c6ef5; box-shadow:0 0 0 3px rgba(76,110,245,0.1);}
        .add-btn { background:#40c057; color:white; border:none; border-radius:10px; padding:12px 20px; cursor:pointer; font-weight:bold; font-size:14px; transition:all 0.3s; white-space:nowrap;}
        .add-btn:hover { background:#2f9e44; transform:translateY(-2px);}
        .installments-container { display:grid; grid-template-columns:repeat(auto-fit,minmax(350px,1fr)); gap:20px; margin-top:20px;}
        .loan-card { background:white; border-radius:15px; padding:20px; border-left:5px solid #4c6ef5; box-shadow:0 5px 15px rgba(0,0,0,0.1); transition:all 0.3s;}
        .loan-card:hover { transform:translateY(-3px); box-shadow:0 8px 25px rgba(0,0,0,0.15);}
        .loan-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; padding-bottom:10px; border-bottom:2px solid #f8f9fa;}
        .loan-title { font-size:18px; font-weight:bold; color:#2c3e50;}
        .loan-amount { font-size:20px; font-weight:bold; color:#e03131; direction:ltr; text-align:left;}
        .loan-details { display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; margin-bottom:15px;}
        .detail-item { background:#f8f9fa; padding:10px; border-radius:8px; text-align:center;}
        .detail-label { font-size:11px; color:#6c757d; margin-bottom:5px;}
        .detail-value { font-size:14px; font-weight:bold; color:#495057;}
        .installments-list { margin-top:15px;}
        .installment-row { display:grid; grid-template-columns:1fr 1fr auto; gap:10px; padding:10px; margin-bottom:8px; background:#f8f9fa; border-radius:8px; align-items:center; transition:all 0.3s;}
        .installment-row.upcoming { background:#fff3cd; border-right:3px solid #ffc107;}
        .installment-row.overdue { background:#ffe3e3; border-right:3px solid #fa5252;}
        .installment-row.paid { background:#d3f9d8; border-right:3px solid #40c057; opacity:0.8;}
        .installment-date { font-size:13px; font-weight:500;}
        .installment-amount { font-size:14px; font-weight:bold; color:#495057; direction:ltr; text-align:left;}
        .payment-buttons { display:flex; gap:5px;}
        .pay-btn { padding:6px 12px; border:none; border-radius:6px; cursor:pointer; font-size:11px; font-weight:bold; transition:all 0.3s;}
        .pay-btn.paid { background:#40c057; color:white;}
        .pay-btn.unpaid { background:#fa5252; color:white;}
        .pay-btn:hover { transform:scale(1.05);}
        .pay-btn:disabled { opacity:0.6; cursor:not-allowed; transform:none;}
        .loan-actions { display:flex; justify-content:space-between; align-items:center; margin-top:15px; padding-top:10px; border-top:2px solid #f8f9fa;}
        .delete-btn { background:#fa5252; color:white; border:none; border-radius:6px; padding:8px 15px; cursor:pointer; font-size:12px; transition:all 0.3s;}
        .delete-btn:hover { background:#e03131; transform:scale(1.05);}
        .loan-status { font-size:12px; font-weight:bold; padding:5px 10px; border-radius:15px;}
        .status-active { background:#fff3cd; color:#856404;}
        .status-completed { background:#d3f9d8; color:#0f5132;}
        .empty-state { text-align:center; padding:60px 20px; color:#6c757d; grid-column:1 / -1;}
        .empty-state i { font-size:80px; margin-bottom:20px; display:block; color:#adb5bd;}
        .stats { display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:15px; margin-top:30px;}
        .stat-card { background:white; padding:20px; border-radius:12px; text-align:center; box-shadow:0 5px 15px rgba(0,0,0,0.1);}
        .stat-value { font-size:1.8rem; font-weight:bold; color:#4c6ef5; margin-bottom:5px;}
        .stat-label { color:#6c757d; font-size:14px;}
        .notification { position:fixed; top:20px; left:50%; transform:translateX(-50%); background:#40c057; color:white; padding:15px 25px; border-radius:10px; box-shadow:0 5px 15px rgba(0,0,0,0.2); z-index:1000; display:none;}
        .section-title { font-size:1.5rem; color:#2c3e50; margin-bottom:20px; padding-bottom:10px; border-bottom:2px solid #f8f9fa;}
        .data-management { display:grid; grid-template-columns:1fr 1fr 1fr; gap:15px; margin-top:20px; padding:20px; background:#f8f9fa; border-radius:15px;}
        .data-btn { padding:12px 20px; border:none; border-radius:10px; cursor:pointer; font-weight:bold; font-size:14px; transition:all 0.3s;}
        .export-btn { background:#4c6ef5; color:white;}
        .import-btn { background:#ff922b; color:white;}
        .clear-btn { background:#fa5252; color:white;}
        .data-btn:hover { transform:translateY(-2px); opacity:0.9;}
        .file-input { display:none;}
    </style>
</head>
<body>
<div class="container">
    <header>
        <h1>ğŸ’³ Ù…Ø¯ÛŒØ±ÛŒØª Ø§Ù‚Ø³Ø§Ø·</h1>
        <p class="creator">Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ Ù…Ø¯ÛŒØ±ÛŒØª ÙˆØ§Ù…â€ŒÙ‡Ø§ - Ø·Ø±Ø§Ø­ÛŒ Ø´Ø¯Ù‡ ØªÙˆØ³Ø· Ø¢Ø±ÛŒÙˆ Ù…Ù‚ØªØ¯Ø±</p>
    </header>

    <div class="main-card">
        <h3 class="section-title">â• Ø§ÙØ²ÙˆØ¯Ù† ÙˆØ§Ù… Ø¬Ø¯ÛŒØ¯</h3>
        <div class="add-installment-form">
            <input type="text" class="form-input" id="installmentName" placeholder="Ù†Ø§Ù… ÙˆØ§Ù…" required>
            <input type="text" class="form-input" id="installmentMonthly" placeholder="Ù‚Ø³Ø· Ù…Ø§Ù‡ÛŒØ§Ù†Ù‡ (ØªÙˆÙ…Ø§Ù†)" required>
            <input type="number" class="form-input" id="installmentDay" placeholder="Ø±ÙˆØ² Ø³Ø±Ø±Ø³ÛŒØ¯ (Û±-Û³Û±)" min="1" max="31" required>
            <input type="date" class="form-input" id="startDate" placeholder="ØªØ§Ø±ÛŒØ® Ø´Ø±ÙˆØ¹" required>
            <input type="date" class="form-input" id="endDate" placeholder="ØªØ§Ø±ÛŒØ® Ù¾Ø§ÛŒØ§Ù†" required>
            <input type="number" class="form-input" id="installmentMonths" placeholder="Ù…Ø§Ù‡â€ŒÙ‡Ø§ÛŒ Ù…Ø§Ù†Ø¯Ù‡" min="1" max="120" required readonly>
            <button class="add-btn" onclick="addInstallment()">â• Ø§ÙØ²ÙˆØ¯Ù† ÙˆØ§Ù…</button>
        </div>

        <h3 class="section-title">ğŸ“‹ Ù„ÛŒØ³Øª ÙˆØ§Ù…â€ŒÙ‡Ø§</h3>
        <div class="installments-container" id="installmentsContainer"></div>

        <h3 class="section-title">ğŸ’¾ Ù…Ø¯ÛŒØ±ÛŒØª Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§</h3>
        <div class="data-management">
            <button class="data-btn export-btn" onclick="exportData()">ğŸ“¥ Ø®Ø±ÙˆØ¬ÛŒ Ú¯Ø±ÙØªÙ†</button>
            <button class="data-btn import-btn" onclick="document.getElementById('importFile').click()">ğŸ“¤ ÙˆØ§Ø±Ø¯ Ú©Ø±Ø¯Ù†</button>
            <button class="data-btn clear-btn" onclick="clearAllData()">ğŸ—‘ï¸ Ø­Ø°Ù Ù‡Ù…Ù‡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§</button>
            <button class="data-btn export-btn" onclick="testNotificationCheckDue()">ğŸ›ï¸ ØªØ³Øª Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù†</button>
            <input type="file" id="importFile" class="file-input" accept=".json" onchange="importData(event)">
        </div>

        <div class="stats">
            <div class="stat-card"><div class="stat-value" id="totalLoans">0</div><div class="stat-label">ØªØ¹Ø¯Ø§Ø¯ ÙˆØ§Ù…â€ŒÙ‡Ø§</div></div>
            <div class="stat-card"><div class="stat-value" id="upcomingCount">0</div><div class="stat-label">Ù‚Ø³Ø·â€ŒÙ‡Ø§ÛŒ Ù¾ÛŒØ´â€ŒØ±Ùˆ</div></div>
            <div class="stat-card"><div class="stat-value" id="totalRemaining">0</div><div class="stat-label">Ù…Ø¬Ù…ÙˆØ¹ Ù…Ø§Ù†Ø¯Ù‡ (ØªÙˆÙ…Ø§Ù†)</div></div>
            <div class="stat-card"><div class="stat-value" id="overdueCount">0</div><div class="stat-label">Ù‚Ø³Ø·â€ŒÙ‡Ø§ÛŒ Ù…Ø¹ÙˆÙ‚</div></div>
        </div>
    </div>
</div>

<div class="notification" id="notification"></div>
<audio id="notifSound" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" preload="auto"></audio>

<script>
let loans = JSON.parse(localStorage.getItem('loans'))||[];
const persianMonths=['ÙØ±ÙˆØ±Ø¯ÛŒÙ†','Ø§Ø±Ø¯ÛŒØ¨Ù‡Ø´Øª','Ø®Ø±Ø¯Ø§Ø¯','ØªÛŒØ±','Ù…Ø±Ø¯Ø§Ø¯','Ø´Ù‡Ø±ÛŒÙˆØ±','Ù…Ù‡Ø±','Ø¢Ø¨Ø§Ù†','Ø¢Ø°Ø±','Ø¯ÛŒ','Ø¨Ù‡Ù…Ù†','Ø§Ø³ÙÙ†Ø¯'];

// ØªØ¨Ø¯ÛŒÙ„ ØªØ§Ø±ÛŒØ® Ù…ÛŒÙ„Ø§Ø¯ÛŒ Ø¨Ù‡ Ø´Ù…Ø³ÛŒ
function gregorianToJalali(gy,gm,gd){
    let g_d_m=[0,31,59,90,120,151,181,212,243,273,304,334]; 
    let jy=(gy<=1600)?0:979; 
    gy-=(gy<=1600)?621:1600; 
    let gy2=(gm>2)?(gy+1):gy; 
    let days=(365*gy)+parseInt((gy2+3)/4)-parseInt((gy2+99)/100)+parseInt((gy2+399)/400)-80+gd+g_d_m[gm-1]; 
    jy+=33*parseInt(days/12053); 
    days%=12053; 
    jy+=4*parseInt(days/1461); 
    days%=1461; 
    jy+=parseInt((days-1)/365); 
    if(days>365) days=(days-1)%365; 
    let jm=(days<186)?1+parseInt(days/31):7+parseInt((days-186)/30); 
    let jd=1+((days<186)?(days%31):((days-186)%30)); 
    return [jy,jm,jd];
}

// ØªØ¨Ø¯ÛŒÙ„ ØªØ§Ø±ÛŒØ® Ø´Ù…Ø³ÛŒ Ø¨Ù‡ Ù…ÛŒÙ„Ø§Ø¯ÛŒ
function jalaliToGregorian(jy,jm,jd){
    jy+=1595;
    let days=-355668+(365*jy)+parseInt(jy/33)*8+parseInt(((jy%33)+3)/4)+jd;
    if(jm<7) days+=(jm-1)*31;
    else days+=((jm-7)*30)+186;
    let gy=400*parseInt(days/146097);
    days%=146097;
    if(days>36524){
        gy+=100*parseInt(--days/36524);
        days%=36524;
        if(days>=365) days++;
    }
    gy+=4*parseInt(days/1461);
    days%=1461;
    if(days>365){
        gy+=parseInt((days-1)/365);
        days=(days-1)%365;
    }
    let gd=days+1;
    let sal_a=[0,31,((gy%4===0 && gy%100!==0) || (gy%400===0))?29:28,31,30,31,30,31,31,30,31,30,31];
    let gm;
    for(gm=0;gm<13;gm++){
        let v=sal_a[gm];
        if(gd<=v) break;
        gd-=v;
    }
    return [gy,gm,gd];
}

// Ú¯Ø±ÙØªÙ† ØªØ§Ø±ÛŒØ® Ø§Ù…Ø±ÙˆØ² Ø¨Ù‡ Ø´Ù…Ø³ÛŒ
function getTodayPersianDate(){ 
    const today=new Date(); 
    const [jy,jm,jd]=gregorianToJalali(today.getFullYear(),today.getMonth()+1,today.getDate()); 
    return {year:jy,month:jm,day:jd,dateStr:`${jy}/${jm}/${jd}`};
}

// ÙØ±Ù…Øª Ú©Ø±Ø¯Ù† Ø§Ø¹Ø¯Ø§Ø¯
function formatNumber(num){ return new Intl.NumberFormat('fa-IR').format(num);}

// ØªØ¨Ø¯ÛŒÙ„ Ù…Ø¨Ù„Øº Ø¨Ù‡ Ø¹Ø¯Ø¯
function parseAmount(str){ return parseInt(str.replace(/[^\d]/g,''))||0;}

// Ù†Ù…Ø§ÛŒØ´ Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù†
function showNotification(msg,type='success'){ 
    const n=document.getElementById('notification'); 
    n.textContent=msg; 
    n.style.background=type==='success'?'#40c057':'#fa5252'; 
    n.style.display='block'; 
    setTimeout(()=>{ n.style.display='none'; },3000);
}

// Ù†Ù…Ø§ÛŒØ´ Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† Ø¨Ø§ ØµØ¯Ø§
function showNotificationWithSound(title,body){ 
    const sound=document.getElementById('notifSound'); 
    if("Notification" in window && Notification.permission==="granted"){ 
        for(let i=0;i<5;i++){ 
            new Notification(title,{body:body,icon:"https://cdn-icons-png.flaticon.com/512/190/190411.png"}); 
            sound.play(); 
        } 
    } else { 
        for(let i=0;i<5;i++){ 
            showNotification(`${title}: ${body}`,'error'); 
            sound.play(); 
        } 
    }
}

// Ù…Ø­Ø§Ø³Ø¨Ù‡ ØªØ§Ø±ÛŒØ®â€ŒÙ‡Ø§ÛŒ Ù‚Ø³Ø· Ø¨Ø± Ø§Ø³Ø§Ø³ ØªØ§Ø±ÛŒØ® Ø´Ø±ÙˆØ¹ Ùˆ Ù¾Ø§ÛŒØ§Ù†
function calculateInstallmentDates(startDate, endDate, day){
    const dates=[];
    
    // ØªØ¨Ø¯ÛŒÙ„ ØªØ§Ø±ÛŒØ® Ø´Ø±ÙˆØ¹ Ø¨Ù‡ Ø´Ù…Ø³ÛŒ
    const startParts = startDate.split('-');
    const [startJy, startJm, startJd] = gregorianToJalali(
        parseInt(startParts[0]), 
        parseInt(startParts[1]), 
        parseInt(startParts[2])
    );
    
    // ØªØ¨Ø¯ÛŒÙ„ ØªØ§Ø±ÛŒØ® Ù¾Ø§ÛŒØ§Ù† Ø¨Ù‡ Ø´Ù…Ø³ÛŒ
    const endParts = endDate.split('-');
    const [endJy, endJm, endJd] = gregorianToJalali(
        parseInt(endParts[0]), 
        parseInt(endParts[1]), 
        parseInt(endParts[2])
    );
    
    // Ù…Ø­Ø§Ø³Ø¨Ù‡ ØªØ¹Ø¯Ø§Ø¯ Ù…Ø§Ù‡â€ŒÙ‡Ø§
    const monthsDiff = (endJy - startJy) * 12 + (endJm - startJm) + 1;
    
    // Ø§ÛŒØ¬Ø§Ø¯ ØªØ§Ø±ÛŒØ®â€ŒÙ‡Ø§ÛŒ Ù‚Ø³Ø·
    for(let i=0; i<monthsDiff; i++){
        let year = startJy;
        let month = startJm + i;
        
        // ØªÙ†Ø¸ÛŒÙ… Ø³Ø§Ù„ Ùˆ Ù…Ø§Ù‡
        while(month > 12){
            month -= 12;
            year += 1;
        }
        
        // ØªÙ†Ø¸ÛŒÙ… Ø±ÙˆØ² Ù‚Ø³Ø·
        let installmentDay = day;
        
        // Ø§Ú¯Ø± Ø±ÙˆØ² Ù‚Ø³Ø· Ø¨ÛŒØ´ØªØ± Ø§Ø² Ø±ÙˆØ²Ù‡Ø§ÛŒ Ù…Ø§Ù‡ Ø¨Ø§Ø´Ø¯ØŒ Ø§Ø² Ø¢Ø®Ø± Ù…Ø§Ù‡ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†
        const daysInMonth = month < 7 ? 31 : month < 12 ? 30 : 29;
        if(installmentDay > daysInMonth){
            installmentDay = daysInMonth;
        }
        
        const installmentDate = { 
            year: year, 
            month: month, 
            day: installmentDay, 
            dateStr: `${year}/${month}/${installmentDay}`, 
            displayDate: `${installmentDay} ${persianMonths[month-1]} ${year}`, 
            isPaid: false, 
            isOverdue: isDateOverdue(year, month, installmentDay) 
        };
        dates.push(installmentDate);
    }
    
    return dates;
}

// Ø¨Ø±Ø±Ø³ÛŒ ØªØ§Ø±ÛŒØ® Ø³Ø±Ø±Ø³ÛŒØ¯
function isDateOverdue(y,m,d){ 
    const t=getTodayPersianDate(); 
    if(y<t.year) return true; 
    if(y===t.year && m<t.month) return true; 
    if(y===t.year && m===t.month && d<t.day) return true; 
    return false;
}

// Ù…Ø­Ø§Ø³Ø¨Ù‡ ØªØ¹Ø¯Ø§Ø¯ Ù…Ø§Ù‡â€ŒÙ‡Ø§ Ø¨ÛŒÙ† Ø¯Ùˆ ØªØ§Ø±ÛŒØ®
function calculateMonthsBetweenDates(startDate, endDate){
    const startParts = startDate.split('-');
    const endParts = endDate.split('-');
    
    const start = new Date(startParts[0], startParts[1]-1, startParts[2]);
    const end = new Date(endParts[0], endParts[1]-1, endParts[2]);
    
    return (end.getFullYear() - start.getFullYear()) * 12 + (end.getMonth() - start.getMonth()) + 1;
}

// Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ØªØ¹Ø¯Ø§Ø¯ Ù…Ø§Ù‡â€ŒÙ‡Ø§ Ø¨Ø± Ø§Ø³Ø§Ø³ ØªØ§Ø±ÛŒØ®â€ŒÙ‡Ø§
function updateMonthsFromDates(){
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    
    if(startDate && endDate){
        const months = calculateMonthsBetweenDates(startDate, endDate);
        document.getElementById('installmentMonths').value = months;
    }
}

// Ø§ÙØ²ÙˆØ¯Ù† ÙˆØ§Ù…
function addInstallment(){
    const name=document.getElementById('installmentName').value.trim();
    const monthly=parseAmount(document.getElementById('installmentMonthly').value);
    const day=parseInt(document.getElementById('installmentDay').value);
    const startDate=document.getElementById('startDate').value;
    const endDate=document.getElementById('endDate').value;
    const months=parseInt(document.getElementById('installmentMonths').value);
    
    if(!name){ showNotification('Ù„Ø·ÙØ§Ù‹ Ù†Ø§Ù… ÙˆØ§Ù… Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯','error'); return;}
    if(monthly<=0){ showNotification('Ù…Ø¨Ù„Øº Ù‚Ø³Ø· Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª','error'); return;}
    if(day<1 || day>31){ showNotification('Ø±ÙˆØ² Ø³Ø±Ø±Ø³ÛŒØ¯ Û± ØªØ§ Û³Û±','error'); return;}
    if(!startDate){ showNotification('Ù„Ø·ÙØ§Ù‹ ØªØ§Ø±ÛŒØ® Ø´Ø±ÙˆØ¹ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯','error'); return;}
    if(!endDate){ showNotification('Ù„Ø·ÙØ§Ù‹ ØªØ§Ø±ÛŒØ® Ù¾Ø§ÛŒØ§Ù† Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯','error'); return;}
    if(months<1 || months>120){ showNotification('ØªØ¹Ø¯Ø§Ø¯ Ù…Ø§Ù‡â€ŒÙ‡Ø§ Û± ØªØ§ Û±Û²Û°','error'); return;}
    
    // Ø¨Ø±Ø±Ø³ÛŒ Ø§ÛŒÙ†Ú©Ù‡ ØªØ§Ø±ÛŒØ® Ù¾Ø§ÛŒØ§Ù† Ø¨Ø¹Ø¯ Ø§Ø² ØªØ§Ø±ÛŒØ® Ø´Ø±ÙˆØ¹ Ø¨Ø§Ø´Ø¯
    if(new Date(endDate) <= new Date(startDate)){
        showNotification('ØªØ§Ø±ÛŒØ® Ù¾Ø§ÛŒØ§Ù† Ø¨Ø§ÛŒØ¯ Ø¨Ø¹Ø¯ Ø§Ø² ØªØ§Ø±ÛŒØ® Ø´Ø±ÙˆØ¹ Ø¨Ø§Ø´Ø¯','error');
        return;
    }
    
    const installmentDates=calculateInstallmentDates(startDate, endDate, day);
    loans.push({ 
        id:Date.now(), 
        name:name, 
        monthlyAmount:monthly, 
        totalRemainingAmount:monthly*months, 
        day:day, 
        remainingMonths:months, 
        startDate:startDate,
        endDate:endDate,
        dates:installmentDates, 
        createdAt:new Date().toISOString(), 
        isActive:true 
    });
    
    saveLoans(); 
    renderLoans(); 
    updateStats();
    
    // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ÙØ±Ù…
    document.getElementById('installmentName').value=''; 
    document.getElementById('installmentMonthly').value=''; 
    document.getElementById('installmentDay').value=''; 
    document.getElementById('startDate').value=''; 
    document.getElementById('endDate').value=''; 
    document.getElementById('installmentMonths').value='';
    
    showNotification('ÙˆØ§Ù… Ø¬Ø¯ÛŒØ¯ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯');
}

// Ø­Ø°Ù ÙˆØ§Ù…
function deleteLoan(id){ 
    if(confirm('Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† ÙˆØ§Ù… Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ')){ 
        loans=loans.filter(l=>l.id!==id); 
        saveLoans(); 
        renderLoans(); 
        updateStats(); 
        showNotification('ÙˆØ§Ù… Ø­Ø°Ù Ø´Ø¯');
    }
}

// Ù¾Ø±Ø¯Ø§Ø®Øª Ù‚Ø³Ø·
function togglePayment(loanId,dateIndex,status){ 
    const loan=loans.find(l=>l.id===loanId); 
    if(loan){ 
        loan.dates[dateIndex].isPaid=status; 
        const unpaidCount=loan.dates.filter(d=>!d.isPaid).length; 
        loan.remainingMonths=unpaidCount; 
        loan.totalRemainingAmount=loan.monthlyAmount*unpaidCount; 
        loan.isActive=unpaidCount>0; 
        saveLoans(); 
        renderLoans(); 
        updateStats(); 
        showNotification(`Ù‚Ø³Ø· ${status?'Ù¾Ø±Ø¯Ø§Ø®Øª Ø´Ø¯':'Ù¾Ø±Ø¯Ø§Ø®Øª Ù†Ø´Ø¯'}`);
    }
}

// Ù†Ù…Ø§ÛŒØ´ ÙˆØ§Ù…â€ŒÙ‡Ø§
function renderLoans(){ 
    const container=document.getElementById('installmentsContainer'); 
    if(loans.length===0){ 
        container.innerHTML=`<div class="empty-state"><i>ğŸ’³</i><h3>Ù‡ÛŒÚ† ÙˆØ§Ù…ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</h3><p>ÙˆØ§Ù… Ø§ÙˆÙ„ Ø®ÙˆØ¯ Ø±Ø§ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒØ¯</p></div>`; 
        return;
    }
    
    container.innerHTML=''; 
    loans.forEach(loan=>{ 
        let installmentsHTML=''; 
        loan.dates.forEach((d,i)=>{ 
            let rowClass=d.isPaid?'paid':d.isOverdue?'overdue':'upcoming'; 
            installmentsHTML+=`
                <div class="installment-row ${rowClass}">
                    <div class="installment-date">${d.displayDate}</div>
                    <div class="installment-amount">${formatNumber(loan.monthlyAmount)}</div>
                    <div class="payment-buttons">
                        <button class="pay-btn ${d.isPaid?'paid':'unpaid'}" onclick="togglePayment(${loan.id},${i},${!d.isPaid})">
                            ${d.isPaid?'Ù¾Ø±Ø¯Ø§Ø®Øª Ø´Ø¯':'Ù¾Ø±Ø¯Ø§Ø®Øª Ù†Ø´Ø¯Ù‡'}
                        </button>
                    </div>
                </div>
            `;
        }); 
        
        // ØªØ¨Ø¯ÛŒÙ„ ØªØ§Ø±ÛŒØ® Ø´Ø±ÙˆØ¹ Ùˆ Ù¾Ø§ÛŒØ§Ù† Ø¨Ù‡ Ø´Ù…Ø³ÛŒ
        const startParts = loan.startDate.split('-');
        const [startJy, startJm, startJd] = gregorianToJalali(
            parseInt(startParts[0]), 
            parseInt(startParts[1]), 
            parseInt(startParts[2])
        );
        
        const endParts = loan.endDate.split('-');
        const [endJy, endJm, endJd] = gregorianToJalali(
            parseInt(endParts[0]), 
            parseInt(endParts[1]), 
            parseInt(endParts[2])
        );
        
        const startDateStr = `${startJd} ${persianMonths[startJm-1]} ${startJy}`;
        const endDateStr = `${endJd} ${persianMonths[endJm-1]} ${endJy}`;
        
        container.innerHTML+=`
            <div class="loan-card">
                <div class="loan-header">
                    <div class="loan-title">${loan.name}</div>
                    <div class="loan-amount">${formatNumber(loan.totalRemainingAmount)}</div>
                </div>
                <div class="loan-details">
                    <div class="detail-item">
                        <div class="detail-label">Ú©Ù„ Ù‚Ø³Ø·â€ŒÙ‡Ø§</div>
                        <div class="detail-value">${loan.dates.length}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Ù…Ø§Ù†Ø¯Ù‡</div>
                        <div class="detail-value">${loan.remainingMonths}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">ØªØ§Ø±ÛŒØ® Ù¾Ø§ÛŒØ§Ù†</div>
                        <div class="detail-value">${endDateStr}</div>
                    </div>
                </div>
                <div class="installments-list">${installmentsHTML}</div>
                <div class="loan-actions">
                    <span class="loan-status ${loan.isActive?'status-active':'status-completed'}">
                        ${loan.isActive?'ÙØ¹Ø§Ù„':'Ø§ØªÙ…Ø§Ù…'}
                    </span>
                    <button class="delete-btn" onclick="deleteLoan(${loan.id})">Ø­Ø°Ù ÙˆØ§Ù…</button>
                </div>
            </div>
        `; 
    });
}

// Ù…Ø¯ÛŒØ±ÛŒØª Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
function saveLoans(){ localStorage.setItem('loans',JSON.stringify(loans)); }

function exportData(){ 
    const dataStr="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(loans)); 
    const dlAnchor=document.createElement('a'); 
    dlAnchor.setAttribute("href",dataStr); 
    dlAnchor.setAttribute("download","loans.json"); 
    dlAnchor.click();
}

function importData(event){ 
    const file=event.target.files[0]; 
    const reader=new FileReader(); 
    reader.onload=function(e){ 
        try{ 
            loans=JSON.parse(e.target.result); 
            saveLoans(); 
            renderLoans(); 
            updateStats(); 
            showNotification('Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ ÙˆØ§Ø±Ø¯ Ø´Ø¯Ù†Ø¯'); 
        }catch(err){ 
            showNotification('Ø®Ø·Ø§ Ø¯Ø± ÙˆØ§Ø±Ø¯ Ú©Ø±Ø¯Ù† ÙØ§ÛŒÙ„','error'); 
        }
    }; 
    reader.readAsText(file);
}

function clearAllData(){ 
    if(confirm('Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ Ù‡Ù…Ù‡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø­Ø°Ù Ø´ÙˆÙ†Ø¯ØŸ')){ 
        loans=[]; 
        saveLoans(); 
        renderLoans(); 
        updateStats(); 
        showNotification('Ù‡Ù…Ù‡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø­Ø°Ù Ø´Ø¯Ù†Ø¯'); 
    }
}

// Ø¢Ù…Ø§Ø±
function updateStats(){ 
    const totalLoans=loans.length; 
    let upcomingCount=0; 
    let overdueCount=0; 
    let totalRemaining=0; 
    
    loans.forEach(loan=>{ 
        loan.dates.forEach(d=>{ 
            if(!d.isPaid){ 
                const t=getTodayPersianDate(); 
                if(d.year>t.year||(d.year===t.year && d.month>t.month)||(d.year===t.year && d.month===t.month && d.day>=t.day)) 
                    upcomingCount++; 
                if(d.isOverdue && !d.isPaid) 
                    overdueCount++; 
                totalRemaining+=loan.monthlyAmount; 
            } 
        });
    }); 
    
    document.getElementById('totalLoans').textContent=totalLoans; 
    document.getElementById('upcomingCount').textContent=upcomingCount; 
    document.getElementById('overdueCount').textContent=overdueCount; 
    document.getElementById('totalRemaining').textContent=formatNumber(totalRemaining);
}

// Ø¨Ø±Ø±Ø³ÛŒ Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† Ù‚Ø³Ø·â€ŒÙ‡Ø§
function checkInstallmentNotifications(){
    const today=getTodayPersianDate();
    const tomorrowDate=new Date(); 
    tomorrowDate.setDate(tomorrowDate.getDate()+1);
    const [ty,tm,td]=gregorianToJalali(tomorrowDate.getFullYear(),tomorrowDate.getMonth()+1,tomorrowDate.getDate());
    
    loans.forEach(loan=>{
        loan.dates.forEach(date=>{
            if(!date.isPaid){
                if(date.year===today.year && date.month===today.month && date.day===today.day){
                    showNotificationWithSound(`ğŸ’³ Ù‚Ø³Ø· Ø§Ù…Ø±ÙˆØ²: ${loan.name}`,`Ù…Ø¨Ù„Øº: ${formatNumber(loan.monthlyAmount)} ØªÙˆÙ…Ø§Ù†`);
                }
                if(date.year===ty && date.month===tm && date.day===td){
                    showNotificationWithSound(`ğŸ’³ Ù‚Ø³Ø· ÙØ±Ø¯Ø§: ${loan.name}`,`Ù…Ø¨Ù„Øº: ${formatNumber(loan.monthlyAmount)} ØªÙˆÙ…Ø§Ù†`);
                }
            }
        });
    });
}

// Ø¯Ú©Ù…Ù‡ ØªØ³Øª Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù†
function testNotificationCheckDue(){
    const today=getTodayPersianDate();
    const tomorrowDate=new Date(); 
    tomorrowDate.setDate(tomorrowDate.getDate()+1);
    const [ty,tm,td]=gregorianToJalali(tomorrowDate.getFullYear(),tomorrowDate.getMonth()+1,tomorrowDate.getDate());
    let hasDue=false;
    
    loans.forEach(loan=>{
        loan.dates.forEach(date=>{
            if(!date.isPaid){
                if((date.year===today.year && date.month===today.month && date.day===today.day) ||
                   (date.year===ty && date.month===tm && date.day===td)){
                    hasDue=true;
                    showNotificationWithSound(`ğŸ’³ Ù…ÙˆØ¹Ø¯ Ù‚Ø³Ø·: ${loan.name}`,`Ù…Ø¨Ù„Øº: ${formatNumber(loan.monthlyAmount)} ØªÙˆÙ…Ø§Ù†`);
                }
            }
        });
    });
    
    if(!hasDue){
        showNotificationWithSound('ğŸ’³ Ù‡ÛŒÚ† Ù‚Ø³Ø·ÛŒ Ø§Ù…Ø±ÙˆØ² ÛŒØ§ ÙØ±Ø¯Ø§ Ù†ÛŒØ³Øª','Ù…ÙˆØ¹Ø¯ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯');
    }
}

// ØªÙ†Ø¸ÛŒÙ… Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ Ø¨Ø±Ø§ÛŒ ØªØ§Ø±ÛŒØ®â€ŒÙ‡Ø§
document.getElementById('startDate').addEventListener('change', updateMonthsFromDates);
document.getElementById('endDate').addEventListener('change', updateMonthsFromDates);

// Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¯Ø³ØªØ±Ø³ÛŒ Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù†
if("Notification" in window && Notification.permission!=="granted"){ 
    Notification.requestPermission(); 
}

// Ø¨Ø±Ø±Ø³ÛŒ Ù‡Ø± Û³Û° Ø¯Ù‚ÛŒÙ‚Ù‡
setInterval(checkInstallmentNotifications,30*60*1000);

// Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§ÙˆÙ„ÛŒÙ‡
renderLoans();
updateStats();
</script>
</body>
</html>
