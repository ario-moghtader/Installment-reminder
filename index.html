<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ’³ Ù…Ø¯ÛŒØ±ÛŒØª Ø§Ù‚Ø³Ø§Ø· - Ø¢Ø±ÛŒÙˆ Ù…Ù‚ØªØ¯Ø±</title>
<style>
* { margin:0; padding:0; box-sizing:border-box; font-family:'Vazir',Tahoma,sans-serif;}
body { background:#f0f2f5; color:#333; min-height:100vh; padding:20px; }
.container { max-width:800px; margin:0 auto;}
header { text-align:center; margin-bottom:20px; }
h1 { font-size:2rem; margin-bottom:5px; }
.main-card { background:white; border-radius:15px; padding:20px; box-shadow:0 5px 15px rgba(0,0,0,0.1); margin-bottom:20px; }
.add-installment-form { display:grid; grid-template-columns:2fr 1fr 1fr 1fr auto; gap:10px; margin-bottom:20px; }
.add-installment-form input, .add-installment-form button { padding:8px 10px; border-radius:8px; border:1px solid #ccc; font-size:14px; }
.add-installment-form button { background:#40c057; color:white; border:none; cursor:pointer; }
.add-installment-form button:hover { background:#2f9e44; }
.installments-container { display:grid; gap:10px; }
.loan-card { background:#fff; padding:15px; border-radius:10px; border-left:5px solid #4c6ef5; }
.installment-row { display:flex; justify-content:space-between; padding:8px 10px; border-radius:6px; background:#f8f9fa; margin-bottom:5px; }
.notification { position:fixed; top:20px; left:50%; transform:translateX(-50%); background:#40c057; color:white; padding:15px 25px; border-radius:10px; box-shadow:0 5px 15px rgba(0,0,0,0.2); z-index:1000; display:none;}
.data-management { display:flex; gap:10px; margin-top:10px; flex-wrap:wrap; }
.data-management button { padding:10px 15px; border:none; border-radius:8px; cursor:pointer; color:white; font-weight:bold; }
.export-btn { background:#4c6ef5; }
.import-btn { background:#ff922b; }
.clear-btn { background:#fa5252; }
.test-btn { background:#7950f2; }
.file-input { display:none; }
</style>
</head>
<body>
<div class="container">
<header>
<h1>ğŸ’³ Ù…Ø¯ÛŒØ±ÛŒØª Ø§Ù‚Ø³Ø§Ø·</h1>
<p>Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø³Ø§Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ø§Ù‚Ø³Ø§Ø· Ùˆ Ø¯Ø±ÛŒØ§ÙØª Ù‡Ø´Ø¯Ø§Ø±</p>
</header>

<div class="main-card">
<h3>â• Ø§ÙØ²ÙˆØ¯Ù† ÙˆØ§Ù… Ø¬Ø¯ÛŒØ¯</h3>
<div class="add-installment-form">
<input type="text" id="installmentName" placeholder="Ù†Ø§Ù… ÙˆØ§Ù…">
<input type="text" id="installmentMonthly" placeholder="Ù‚Ø³Ø· Ù…Ø§Ù‡ÛŒØ§Ù†Ù‡ (ØªÙˆÙ…Ø§Ù†)">
<input type="number" id="installmentDay" placeholder="Ø±ÙˆØ² Ø³Ø±Ø±Ø³ÛŒØ¯ (Û±-Û³Û±)" min="1" max="31">
<input type="number" id="installmentMonths" placeholder="Ù…Ø§Ù‡â€ŒÙ‡Ø§ÛŒ Ù…Ø§Ù†Ø¯Ù‡" min="1" max="120">
<button onclick="addInstallment()">â• Ø§ÙØ²ÙˆØ¯Ù† ÙˆØ§Ù…</button>
</div>

<h3>ğŸ“‹ Ù„ÛŒØ³Øª ÙˆØ§Ù…â€ŒÙ‡Ø§</h3>
<div class="installments-container" id="installmentsContainer"></div>

<h3>ğŸ’¾ Ù…Ø¯ÛŒØ±ÛŒØª Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§</h3>
<div class="data-management">
<button class="export-btn" onclick="exportData()">ğŸ“¥ Ø®Ø±ÙˆØ¬ÛŒ Ú¯Ø±ÙØªÙ†</button>
<button class="import-btn" onclick="document.getElementById('importFile').click()">ğŸ“¤ ÙˆØ§Ø±Ø¯ Ú©Ø±Ø¯Ù†</button>
<button class="clear-btn" onclick="clearAllData()">ğŸ—‘ï¸ Ø­Ø°Ù Ù‡Ù…Ù‡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§</button>
<button class="test-btn" onclick="testNotificationCheckDue()">ğŸ”” ØªØ³Øª Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù†</button>
<input type="file" id="importFile" class="file-input" accept=".json" onchange="importData(event)">
</div>
</div>
<div class="notification" id="notification"></div>
<audio id="notifSound" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" preload="auto"></audio>

<script>
let loans = JSON.parse(localStorage.getItem('loans'))||[];
const persianMonths=['ÙØ±ÙˆØ±Ø¯ÛŒÙ†','Ø§Ø±Ø¯ÛŒØ¨Ù‡Ø´Øª','Ø®Ø±Ø¯Ø§Ø¯','ØªÛŒØ±','Ù…Ø±Ø¯Ø§Ø¯','Ø´Ù‡Ø±ÛŒÙˆØ±','Ù…Ù‡Ø±','Ø¢Ø¨Ø§Ù†','Ø¢Ø°Ø±','Ø¯ÛŒ','Ø¨Ù‡Ù…Ù†','Ø§Ø³ÙÙ†Ø¯'];

function gregorianToJalali(gy,gm,gd){
let g_d_m=[0,31,59,90,120,151,181,212,243,273,304,334]; let jy=(gy<=1600)?0:979; gy-=(gy<=1600)?621:1600; let gy2=(gm>2)?(gy+1):gy; let days=(365*gy)+parseInt((gy2+3)/4)-parseInt((gy2+99)/100)+parseInt((gy2+399)/400)-80+gd+g_d_m[gm-1]; jy+=33*parseInt(days/12053); days%=12053; jy+=4*parseInt(days/1461); days%=1461; jy+=parseInt((days-1)/365); if(days>365) days=(days-1)%365; let jm=(days<186)?1+parseInt(days/31):7+parseInt((days-186)/30); let jd=1+((days<186)?(days%31):((days-186)%30)); return [jy,jm,jd];
}
function getTodayPersianDate(){ const today=new Date(); const [jy,jm,jd]=gregorianToJalali(today.getFullYear(),today.getMonth()+1,today.getDate()); return {year:jy,month:jm,day:jd,dateStr:`${jy}/${jm}/${jd}`};}
function formatNumber(num){ return new Intl.NumberFormat('fa-IR').format(num);}
function parseAmount(str){ return parseInt(str.replace(/[^\d]/g,''))||0;}
function showNotification(msg,type='success'){ const n=document.getElementById('notification'); n.textContent=msg; n.style.background=type==='success'?'#40c057':'#fa5252'; n.style.display='block'; setTimeout(()=>{ n.style.display='none'; },3000);}
function showNotificationWithSound(title,body){ const sound=document.getElementById('notifSound'); if("Notification" in window && Notification.permission==="granted"){ for(let i=0;i<5;i++){ new Notification(`âš ï¸ ${title} âš ï¸`,{body:body,icon:"https://cdn-icons-png.flaticon.com/512/190/190411.png"}); sound.play(); } } else { for(let i=0;i<5;i++){ showNotification(`âš ï¸ ${title}: ${body} âš ï¸`,'error'); sound.play(); } }}

// ØªØ§Ø±ÛŒØ® Ø§Ù‚Ø³Ø§Ø·
function calculateInstallmentDates(day,months){
const dates=[]; const today=getTodayPersianDate();
for(let i=0;i<months;i++){ let year=today.year; let month=today.month+i; while(month>12){ month-=12; year+=1; } dates.push({year:year,month:month,day:day,dateStr:`${year}/${month}/${day}`,displayDate:`${day} ${persianMonths[month-1]} ${year}`,isPaid:false,isOverdue:isDateOverdue(year,month,day)});}
return dates;
}
function isDateOverdue(y,m,d){ const t=getTodayPersianDate(); if(y<t.year)return true; if(y===t.year && m<t.month)return true; if(y===t.year && m===t.month && d<t.day)return true; return false;}

// Ø§ÙØ²ÙˆØ¯Ù† ÙˆØ§Ù…
function addInstallment(){
const name=document.getElementById('installmentName').value.trim();
const monthly=parseAmount(document.getElementById('installmentMonthly').value);
const day=parseInt(document.getElementById('installmentDay').value);
const months=parseInt(document.getElementById('installmentMonths').value);
if(!name){ showNotification('Ù„Ø·ÙØ§Ù‹ Ù†Ø§Ù… ÙˆØ§Ù… Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯','error'); return;}
if(monthly<=0){ showNotification('Ù…Ø¨Ù„Øº Ù‚Ø³Ø· Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª','error'); return;}
if(day<1||day>31){ showNotification('Ø±ÙˆØ² Ø³Ø±Ø±Ø³ÛŒØ¯ Û± ØªØ§ Û³Û±','error'); return;}
if(months<1||months>120){ showNotification('Ù…Ø§Ù‡â€ŒÙ‡Ø§ÛŒ Ù…Ø§Ù†Ø¯Ù‡ Û± ØªØ§ Û±Û²Û°','error'); return;}
const installmentDates=calculateInstallmentDates(day,months);
loans.push({ id:Date.now(), name:name, monthlyAmount:monthly, totalRemainingAmount:monthly*months, day:day, remainingMonths:months, dates:installmentDates, createdAt:new Date().toISOString(), isActive:true });
saveLoans(); renderLoans(); document.getElementById('installmentName').value=''; document.getElementById('installmentMonthly').value=''; document.getElementById('installmentDay').value=''; document.getElementById('installmentMonths').value='';
showNotification('ÙˆØ§Ù… Ø¬Ø¯ÛŒØ¯ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯');
}

// Ù†Ù…Ø§ÛŒØ´ Ø§Ù‚Ø³Ø§Ø· ÙÙ‚Ø· Ù…Ø¨Ù„Øº + ØªØ§Ø±ÛŒØ®
function renderLoans(){
const container=document.getElementById('installmentsContainer');
if(loans.length===0){ container.innerHTML=`<div style="text-align:center; padding:20px;">ğŸ’³ Ù‡ÛŒÚ† ÙˆØ§Ù…ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</div>`; return;}
container.innerHTML='';
loans.forEach(loan=>{
let html='';
loan.dates.forEach(d=>{
html+=`<div class="installment-row"><div>âš ï¸ ${formatNumber(d.isPaid?0:loan.monthlyAmount)} ØªÙˆÙ…Ø§Ù† âš ï¸</div><div>${d.displayDate}</div></div>`;
});
container.innerHTML+=`<div class="loan-card"><div style="font-weight:bold; margin-bottom:5px;">${loan.name}</div>${html}</div>`;
});
}

// Ù…Ø¯ÛŒØ±ÛŒØª Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
function saveLoans(){ localStorage.setItem('loans',JSON.stringify(loans)); }
function exportData(){ const dataStr="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(loans)); const dlAnchor=document.createElement('a'); dlAnchor.setAttribute("href",dataStr); dlAnchor.setAttribute("download","loans.json"); dlAnchor.click();}
function importData(event){ const file=event.target.files[0]; const reader=new FileReader(); reader.onload=function(e){ try{ loans=JSON.parse(e.target.result); saveLoans(); renderLoans(); showNotification('Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ ÙˆØ§Ø±Ø¯ Ø´Ø¯Ù†Ø¯'); }catch(err){ showNotification('Ø®Ø·Ø§ Ø¯Ø± ÙˆØ§Ø±Ø¯ Ú©Ø±Ø¯Ù† ÙØ§ÛŒÙ„','error'); }}; reader.readAsText(file);}
function clearAllData(){ if(confirm('Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ Ù‡Ù…Ù‡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø­Ø°Ù Ø´ÙˆÙ†Ø¯ØŸ')){ loans=[]; saveLoans(); renderLoans(); showNotification('Ù‡Ù…Ù‡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø­Ø°Ù Ø´Ø¯Ù†Ø¯');}}

// Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† Ø§Ù‚Ø³Ø§Ø· Ø§Ù…Ø±ÙˆØ²
function checkInstallmentNotifications(){
const today=getTodayPersianDate();
loans.forEach(loan=>{
loan.dates.forEach(date=>{
if(!date.isPaid && date.year===today.year && date.month===today.month && date.day===today.day){
showNotificationWithSound(`Ù‚Ø³Ø· Ø§Ù…Ø±ÙˆØ²: ${loan.name}`,`Ù…Ø¨Ù„Øº: ${formatNumber(loan.monthlyAmount)} ØªÙˆÙ…Ø§Ù†`);
}
});
});
}

// Ø¯Ú©Ù…Ù‡ ØªØ³Øª Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù†
function testNotificationCheckDue(){
const today=getTodayPersianDate();
let hasDue=false;
loans.forEach(loan=>{
loan.dates.forEach(date=>{
if(!date.isPaid && date.year===today.year && date.month===today.month && date.day===today.day){
hasDue=true;
showNotificationWithSound(`Ù…ÙˆØ¹Ø¯ Ù‚Ø³Ø·: ${loan.name}`,`Ù…Ø¨Ù„Øº: ${formatNumber(loan.monthlyAmount)} ØªÙˆÙ…Ø§Ù†`);
}
});
});
if(!hasDue){ showNotificationWithSound('ğŸ’³ Ù‡ÛŒÚ† Ù‚Ø³Ø·ÛŒ Ø§Ù…Ø±ÙˆØ² Ù†ÛŒØ³Øª','Ù…ÙˆØ¹Ø¯ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯'); }
}

if("Notification" in window && Notification.permission!=="granted"){ Notification.requestPermission(); }
// Ø¨Ø±Ø±Ø³ÛŒ Ù‡Ø± Ûµ Ø¯Ù‚ÛŒÙ‚Ù‡
setInterval(checkInstallmentNotifications,5*60*1000);

renderLoans();
</script>
</body>
</html>
