<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø¯ÛŒØ±ÛŒØª Ø§Ù‚Ø³Ø§Ø· - Ø¢Ø±ÛŒÙˆ Ù…Ù‚ØªØ¯Ø±</title>
    <style>
        * { margin:0; padding:0; box-sizing:border-box; font-family:'Vazir',Tahoma,sans-serif;}
        body { background: linear-gradient(135deg,#667eea 0%,#764ba2 100%); color:#333; min-height:100vh; padding:20px; direction:rtl;}
        .container { max-width:1200px; margin:0 auto;}
        header { text-align:center; margin-bottom:30px; color:white; text-shadow:0 2px 5px rgba(0,0,0,0.3);}
        h1 { font-size:2.8rem; margin-bottom:15px;}
        .creator { font-size:1.2rem; opacity:0.9; margin-top:10px;}
        .main-card { background:white; border-radius:20px; padding:30px; box-shadow:0 15px 35px rgba(0,0,0,0.2); margin-bottom:20px;}
        .add-installment-form { display:grid; grid-template-columns:1fr 1fr 1fr 1fr 1fr 1fr auto; gap:15px; margin-bottom:30px; padding:25px; background:#f8f9fa; border-radius:15px;}
        @media(max-width:768px){.add-installment-form{grid-template-columns:1fr;}}
        .form-input { padding:15px; border:2px solid #e9ecef; border-radius:10px; font-size:16px; transition:all 0.3s;}
        .form-input:focus { outline:none; border-color:#4c6ef5; box-shadow:0 0 0 3px rgba(76,110,245,0.1);}
        .add-btn { background:#40c057; color:white; border:none; border-radius:10px; padding:15px 25px; cursor:pointer; font-weight:bold; font-size:16px; transition:all 0.3s; white-space:nowrap;}
        .add-btn:hover { background:#2f9e44; transform:translateY(-2px);}
        .installments-container { display:grid; grid-template-columns:repeat(auto-fit,minmax(400px,1fr)); gap:25px; margin-top:20px;}
        .loan-card { background:white; border-radius:15px; padding:25px; border-left:5px solid #4c6ef5; box-shadow:0 5px 15px rgba(0,0,0,0.1); transition:all 0.3s;}
        .loan-card:hover { transform:translateY(-3px); box-shadow:0 8px 25px rgba(0,0,0,0.15);}
        .loan-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; padding-bottom:15px; border-bottom:2px solid #f8f9fa;}
        .loan-title { font-size:22px; font-weight:bold; color:#2c3e50;}
        .loan-amount { font-size:24px; font-weight:bold; color:#e03131; direction:ltr; text-align:left;}
        .loan-details { display:grid; grid-template-columns:1fr 1fr 1fr; gap:15px; margin-bottom:20px;}
        .detail-item { background:#f8f9fa; padding:15px; border-radius:10px; text-align:center;}
        .detail-label { font-size:14px; color:#6c757d; margin-bottom:8px;}
        .detail-value { font-size:16px; font-weight:bold; color:#495057;}
        .installments-list { margin-top:20px;}
        .installment-row { display:grid; grid-template-columns:1fr 1fr auto; gap:15px; padding:15px; margin-bottom:12px; background:#f8f9fa; border-radius:10px; align-items:center; transition:all 0.3s;}
        .installment-row.upcoming { background:#fff3cd; border-right:3px solid #ffc107;}
        .installment-row.overdue { background:#ffe3e3; border-right:3px solid #fa5252;}
        .installment-row.paid { background:#d3f9d8; border-right:3px solid #40c057; opacity:0.8;}
        .installment-date { font-size:16px; font-weight:500;}
        .installment-amount { font-size:16px; font-weight:bold; color:#495057; direction:ltr; text-align:left;}
        .payment-buttons { display:flex; gap:8px;}
        .pay-btn { padding:8px 15px; border:none; border-radius:6px; cursor:pointer; font-size:14px; font-weight:bold; transition:all 0.3s;}
        .pay-btn.paid { background:#40c057; color:white;}
        .pay-btn.unpaid { background:#fa5252; color:white;}
        .pay-btn:hover { transform:scale(1.05);}
        .pay-btn:disabled { opacity:0.6; cursor:not-allowed; transform:none;}
        .loan-actions { display:flex; justify-content:space-between; align-items:center; margin-top:20px; padding-top:15px; border-top:2px solid #f8f9fa;}
        .delete-btn { background:#fa5252; color:white; border:none; border-radius:6px; padding:10px 20px; cursor:pointer; font-size:14px; transition:all 0.3s;}
        .delete-btn:hover { background:#e03131; transform:scale(1.05);}
        .loan-status { font-size:14px; font-weight:bold; padding:8px 15px; border-radius:15px;}
        .status-active { background:#fff3cd; color:#856404;}
        .status-completed { background:#d3f9d8; color:#0f5132;}
        .empty-state { text-align:center; padding:80px 20px; color:#6c757d; grid-column:1 / -1;}
        .empty-state i { font-size:100px; margin-bottom:25px; display:block; color:#adb5bd;}
        .stats { display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:20px; margin-top:30px;}
        .stat-card { background:white; padding:25px; border-radius:12px; text-align:center; box-shadow:0 5px 15px rgba(0,0,0,0.1);}
        .stat-value { font-size:2.2rem; font-weight:bold; color:#4c6ef5; margin-bottom:8px;}
        .stat-label { color:#6c757d; font-size:16px;}
        .notification { position:fixed; top:20px; left:50%; transform:translateX(-50%); background:#40c057; color:white; padding:15px 25px; border-radius:10px; box-shadow:0 5px 15px rgba(0,0,0,0.2); z-index:1000; display:none;}
        .section-title { font-size:1.8rem; color:#2c3e50; margin-bottom:25px; padding-bottom:15px; border-bottom:2px solid #f8f9fa;}
        .data-management { display:grid; grid-template-columns:1fr 1fr 1fr; gap:20px; margin-top:20px; padding:25px; background:#f8f9fa; border-radius:15px;}
        .data-btn { padding:15px 25px; border:none; border-radius:10px; cursor:pointer; font-weight:bold; font-size:16px; transition:all 0.3s;}
        .export-btn { background:#4c6ef5; color:white;}
        .import-btn { background:#ff922b; color:white;}
        .clear-btn { background:#fa5252; color:white;}
        .data-btn:hover { transform:translateY(-2px); opacity:0.9;}
        .file-input { display:none;}
        
        /* Ø§Ø³ØªØ§ÛŒÙ„ ØªÙ‚ÙˆÛŒÙ… */
        .calendar-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .calendar-nav {
            display: flex;
            gap: 10px;
        }
        
        .nav-btn {
            background: #4c6ef5;
            color: white;
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 20px;
            transition: all 0.3s;
        }
        
        .nav-btn:hover {
            background: #3b5bdb;
            transform: scale(1.1);
        }
        
        .current-month {
            font-size: 1.8rem;
            font-weight: bold;
            color: #3b5bdb;
        }
        
        .weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            text-align: center;
            font-weight: bold;
            margin-bottom: 15px;
            color: #495057;
            font-size: 16px;
        }
        
        .days-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
        }
        
        .day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
            position: relative;
            flex-direction: column;
            padding: 8px;
            min-height: 55px;
            font-size: 16px;
        }
        
        .day:hover {
            background: #e9ecef;
            transform: scale(1.05);
        }
        
        .current-day {
            background: #4c6ef5;
            color: white;
            font-weight: bold;
        }
        
        .selected-day {
            background: #ff922b;
            color: white;
            font-weight: bold;
        }
        
        .other-month {
            color: #adb5bd;
        }
        
        .date-selection {
            display: flex;
            gap: 15px;
            margin-top: 15px;
        }
        
        .date-btn {
            padding: 10px 20px;
            background: #4c6ef5;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .date-btn:hover {
            background: #3b5bdb;
        }
        
        .selected-dates {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            font-size: 16px;
        }
    </style>
</head>
<body>
<div class="container">
    <header>
        <h1>ğŸ’³ Ù…Ø¯ÛŒØ±ÛŒØª Ø§Ù‚Ø³Ø§Ø·</h1>
        <p class="creator">Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ Ù…Ø¯ÛŒØ±ÛŒØª ÙˆØ§Ù…â€ŒÙ‡Ø§ - Ø·Ø±Ø§Ø­ÛŒ Ø´Ø¯Ù‡ ØªÙˆØ³Ø· Ø¢Ø±ÛŒÙˆ Ù…Ù‚ØªØ¯Ø±</p>
    </header>

    <div class="main-card">
        <h3 class="section-title">â• Ø§ÙØ²ÙˆØ¯Ù† ÙˆØ§Ù… Ø¬Ø¯ÛŒØ¯</h3>
        <div class="add-installment-form">
            <input type="text" class="form-input" id="installmentName" placeholder="Ù†Ø§Ù… ÙˆØ§Ù…" required>
            <input type="text" class="form-input" id="installmentMonthly" placeholder="Ù‚Ø³Ø· Ù…Ø§Ù‡ÛŒØ§Ù†Ù‡ (ØªÙˆÙ…Ø§Ù†)" required>
            <input type="number" class="form-input" id="installmentDay" placeholder="Ø±ÙˆØ² Ø³Ø±Ø±Ø³ÛŒØ¯ (Û±-Û³Û±)" min="1" max="31" required>
            <input type="text" class="form-input" id="startDate" placeholder="ØªØ§Ø±ÛŒØ® Ø´Ø±ÙˆØ¹" readonly required>
            <input type="text" class="form-input" id="endDate" placeholder="ØªØ§Ø±ÛŒØ® Ù¾Ø§ÛŒØ§Ù†" readonly required>
            <input type="number" class="form-input" id="installmentMonths" placeholder="Ù…Ø§Ù‡â€ŒÙ‡Ø§ÛŒ Ù…Ø§Ù†Ø¯Ù‡" min="1" max="120" required readonly>
            <button class="add-btn" onclick="addInstallment()">â• Ø§ÙØ²ÙˆØ¯Ù† ÙˆØ§Ù…</button>
        </div>

        <div class="calendar-container">
            <div class="calendar-header">
                <div class="calendar-nav">
                    <button class="nav-btn prev-year">Â«</button>
                    <button class="nav-btn prev-month">â€¹</button>
                </div>
                <div class="current-month">Ù…Ù‡Ø± Û±Û´Û°Û´</div>
                <div class="calendar-nav">
                    <button class="nav-btn next-month">â€º</button>
                    <button class="nav-btn next-year">Â»</button>
                </div>
            </div>
            
            <div class="weekdays">
                <div>Ø´</div>
                <div>ÛŒ</div>
                <div>Ø¯</div>
                <div>Ø³</div>
                <div>Ú†</div>
                <div>Ù¾</div>
                <div>Ø¬</div>
            </div>
            
            <div class="days-grid" id="daysGrid">
                <!-- Ø±ÙˆØ²Ù‡Ø§ÛŒ ØªÙ‚ÙˆÛŒÙ… ØªÙˆØ³Ø· Ø¬Ø§ÙˆØ§Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ù¾Ø± Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ -->
            </div>
            
            <div class="date-selection">
                <button class="date-btn" id="setStartDate">Ø§Ù†ØªØ®Ø§Ø¨ Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† ØªØ§Ø±ÛŒØ® Ø´Ø±ÙˆØ¹</button>
                <button class="date-btn" id="setEndDate">Ø§Ù†ØªØ®Ø§Ø¨ Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† ØªØ§Ø±ÛŒØ® Ù¾Ø§ÛŒØ§Ù†</button>
            </div>
            
            <div class="selected-dates">
                <div>ØªØ§Ø±ÛŒØ® Ø´Ø±ÙˆØ¹: <span id="displayStartDate">--</span></div>
                <div>ØªØ§Ø±ÛŒØ® Ù¾Ø§ÛŒØ§Ù†: <span id="displayEndDate">--</span></div>
                <div>ØªØ¹Ø¯Ø§Ø¯ Ù…Ø§Ù‡â€ŒÙ‡Ø§: <span id="displayMonths">--</span></div>
            </div>
        </div>

        <h3 class="section-title">ğŸ“‹ Ù„ÛŒØ³Øª ÙˆØ§Ù…â€ŒÙ‡Ø§</h3>
        <div class="installments-container" id="installmentsContainer"></div>

        <h3 class="section-title">ğŸ’¾ Ù…Ø¯ÛŒØ±ÛŒØª Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§</h3>
        <div class="data-management">
            <button class="data-btn export-btn" onclick="exportData()">ğŸ“¥ Ø®Ø±ÙˆØ¬ÛŒ Ú¯Ø±ÙØªÙ†</button>
            <button class="data-btn import-btn" onclick="document.getElementById('importFile').click()">ğŸ“¤ ÙˆØ§Ø±Ø¯ Ú©Ø±Ø¯Ù†</button>
            <button class="data-btn clear-btn" onclick="clearAllData()">ğŸ—‘ï¸ Ø­Ø°Ù Ù‡Ù…Ù‡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§</button>
            <button class="data-btn export-btn" onclick="testNotificationCheckDue()">ğŸ›ï¸ ØªØ³Øª Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù†</button>
            <input type="file" id="importFile" class="file-input" accept=".json" onchange="importData(event)">
        </div>

        <div class="stats">
            <div class="stat-card"><div class="stat-value" id="totalLoans">0</div><div class="stat-label">ØªØ¹Ø¯Ø§Ø¯ ÙˆØ§Ù…â€ŒÙ‡Ø§</div></div>
            <div class="stat-card"><div class="stat-value" id="upcomingCount">0</div><div class="stat-label">Ù‚Ø³Ø·â€ŒÙ‡Ø§ÛŒ Ù¾ÛŒØ´â€ŒØ±Ùˆ</div></div>
            <div class="stat-card"><div class="stat-value" id="totalRemaining">0</div><div class="stat-label">Ù…Ø¬Ù…ÙˆØ¹ Ù…Ø§Ù†Ø¯Ù‡ (ØªÙˆÙ…Ø§Ù†)</div></div>
            <div class="stat-card"><div class="stat-value" id="overdueCount">0</div><div class="stat-label">Ù‚Ø³Ø·â€ŒÙ‡Ø§ÛŒ Ù…Ø¹ÙˆÙ‚</div></div>
        </div>
    </div>
</div>

<div class="notification" id="notification"></div>
<audio id="notifSound" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" preload="auto"></audio>

<script>
let loans = JSON.parse(localStorage.getItem('loans'))||[];
const persianMonths=['ÙØ±ÙˆØ±Ø¯ÛŒÙ†','Ø§Ø±Ø¯ÛŒØ¨Ù‡Ø´Øª','Ø®Ø±Ø¯Ø§Ø¯','ØªÛŒØ±','Ù…Ø±Ø¯Ø§Ø¯','Ø´Ù‡Ø±ÛŒÙˆØ±','Ù…Ù‡Ø±','Ø¢Ø¨Ø§Ù†','Ø¢Ø°Ø±','Ø¯ÛŒ','Ø¨Ù‡Ù…Ù†','Ø§Ø³ÙÙ†Ø¯'];

// ØªØ§Ø±ÛŒØ® Ø¬Ø§Ø±ÛŒ Ø´Ù…Ø³ÛŒ
function getCurrentJalaliDate() {
    const now = new Date();
    
    // Ø§Ù„Ú¯ÙˆØ±ÛŒØªÙ… Ø³Ø§Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ ØªØ¨Ø¯ÛŒÙ„ Ù…ÛŒÙ„Ø§Ø¯ÛŒ Ø¨Ù‡ Ø´Ù…Ø³ÛŒ (Ø¨Ø±Ø§ÛŒ Ø³Ø§Ù„ 1404)
    const gregorianYear = now.getFullYear();
    const gregorianMonth = now.getMonth() + 1;
    const gregorianDay = now.getDate();
    
    // Ù…Ø­Ø§Ø³Ø¨Ø§Øª Ø³Ø§Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ ØªØ¨Ø¯ÛŒÙ„ - Ø§ÛŒÙ† ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ Ø³Ø§Ù„ 2025/1404 Ú©Ø§Ø± Ù…ÛŒâ€ŒÚ©Ù†Ø¯
    let jalaliYear, jalaliMonth, jalaliDay;
    
    if (gregorianYear === 2025) {
        jalaliYear = 1404;
        // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…Ø§Ù‡ Ùˆ Ø±ÙˆØ² Ø´Ù…Ø³ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ ØªØ§Ø±ÛŒØ® Ù…ÛŒÙ„Ø§Ø¯ÛŒ
        const startFarvardin = new Date(2025, 2, 21); // 1 ÙØ±ÙˆØ±Ø¯ÛŒÙ† 1404
        const diffTime = now - startFarvardin;
        const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
        
        if (diffDays < 0) {
            // Ù‚Ø¨Ù„ Ø§Ø² ÙØ±ÙˆØ±Ø¯ÛŒÙ† 1404
            jalaliYear = 1403;
            // Ù…Ø­Ø§Ø³Ø¨Ø§Øª Ø¨Ø±Ø§ÛŒ Ø³Ø§Ù„ Ù‚Ø¨Ù„ Ø³Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø´Ø¯Ù‡
        } else {
            jalaliMonth = Math.floor(diffDays / 31) + 1;
            jalaliDay = (diffDays % 31) + 1;
            
            // ØªÙ†Ø¸ÛŒÙ… Ø¯Ù‚ÛŒÙ‚â€ŒØªØ± Ø¨Ø± Ø§Ø³Ø§Ø³ Ø·ÙˆÙ„ Ù…Ø§Ù‡â€ŒÙ‡Ø§ÛŒ Ø´Ù…Ø³ÛŒ
            const monthLengths = [31, 31, 31, 31, 31, 31, 30, 30, 30, 30, 30, 29];
            let dayCounter = diffDays + 1;
            jalaliMonth = 1;
            
            for (let i = 0; i < monthLengths.length; i++) {
                if (dayCounter <= monthLengths[i]) {
                    jalaliDay = dayCounter;
                    break;
                }
                dayCounter -= monthLengths[i];
                jalaliMonth++;
            }
        }
    } else {
        // Ø¨Ø±Ø§ÛŒ Ø³Ø§Ù„â€ŒÙ‡Ø§ÛŒ Ø¯ÛŒÚ¯Ø±ØŒ Ù…Ù‚Ø¯Ø§Ø± Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ù…ÛŒâ€ŒÚ¯Ø°Ø§Ø±ÛŒÙ…
        jalaliYear = 1404;
        jalaliMonth = 7; // Ù…Ù‡Ø±
        jalaliDay = 21;
    }
    
    return {
        year: jalaliYear,
        month: jalaliMonth,
        day: jalaliDay,
        toString: function() {
            return `${this.year}/${this.month}/${this.day}`;
        }
    };
}

// ØªØ¹Ø¯Ø§Ø¯ Ø±ÙˆØ²Ù‡Ø§ÛŒ Ù…Ø§Ù‡ Ø´Ù…Ø³ÛŒ
function getDaysInJalaliMonth(year, month) {
    if (month <= 6) return 31;
    if (month <= 11) return 30;
    return 29; // Ø§Ø³ÙÙ†Ø¯
}

// Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø±ÙˆØ² Ù‡ÙØªÙ‡ Ø¨Ø±Ø§ÛŒ ØªØ§Ø±ÛŒØ® Ø´Ù…Ø³ÛŒ (Ø§Ù„Ú¯ÙˆØ±ÛŒØªÙ… Ø³Ø§Ø¯Ù‡)
function getJalaliDayOfWeek(year, month, day) {
    // Ø§Ù„Ú¯ÙˆØ±ÛŒØªÙ… Ø³Ø§Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø±ÙˆØ² Ù‡ÙØªÙ‡
    // ÙØ±ÙˆØ±Ø¯ÛŒÙ† 1404 Ø§Ø² Ø´Ù†Ø¨Ù‡ Ø´Ø±ÙˆØ¹ Ù…ÛŒâ€ŒØ´ÙˆØ¯
    const startDay = 0; // ÙØ±ÙˆØ±Ø¯ÛŒÙ† 1404 Ø§Ø² Ø´Ù†Ø¨Ù‡ Ø´Ø±ÙˆØ¹ Ù…ÛŒâ€ŒØ´ÙˆØ¯
    let totalDays = day - 1;
    
    for (let m = 1; m < month; m++) {
        totalDays += getDaysInJalaliMonth(year, m);
    }
    
    return (startDay + totalDays) % 7;
}

// ØªÙˆÙ„ÛŒØ¯ ØªÙ‚ÙˆÛŒÙ… Ø¨Ø±Ø§ÛŒ Ù…Ø§Ù‡ Ùˆ Ø³Ø§Ù„ Ù…Ø´Ø®Øµ
function generateCalendar(year, month) {
    const daysGrid = document.getElementById('daysGrid');
    daysGrid.innerHTML = '';
    
    // ØªØ¹Ø¯Ø§Ø¯ Ø±ÙˆØ²Ù‡Ø§ÛŒ Ù…Ø§Ù‡
    const daysInMonth = getDaysInJalaliMonth(year, month);
    
    // Ø±ÙˆØ² Ø§ÙˆÙ„ Ù…Ø§Ù‡ Ø´Ù…Ø³ÛŒ
    const firstDayOfWeek = getJalaliDayOfWeek(year, month, 1);
    
    // Ø±ÙˆØ²Ù‡Ø§ÛŒ Ù…Ø§Ù‡ Ù‚Ø¨Ù„
    let prevMonth = month - 1;
    let prevYear = year;
    if (prevMonth < 1) {
        prevMonth = 12;
        prevYear = year - 1;
    }
    const prevMonthDays = getDaysInJalaliMonth(prevYear, prevMonth);
    
    // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø±ÙˆØ²Ù‡Ø§ÛŒ Ù…Ø§Ù‡ Ù‚Ø¨Ù„
    for (let i = firstDayOfWeek - 1; i >= 0; i--) {
        const dayElement = document.createElement('div');
        dayElement.className = 'day other-month';
        dayElement.textContent = prevMonthDays - i;
        daysGrid.appendChild(dayElement);
    }
    
    // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø±ÙˆØ²Ù‡Ø§ÛŒ Ù…Ø§Ù‡ Ø¬Ø§Ø±ÛŒ
    for (let day = 1; day <= daysInMonth; day++) {
        const dayElement = document.createElement('div');
        const dateStr = `${year}/${month}/${day}`;
        dayElement.className = 'day';
        dayElement.innerHTML = `<div>${day}</div>`;
        dayElement.dataset.date = dateStr;
        
        // Ø§Ú¯Ø± Ø±ÙˆØ² Ø§Ù…Ø±ÙˆØ² Ø§Ø³Øª
        const today = getCurrentJalaliDate().toString();
        if (dateStr === today) {
            dayElement.classList.add('current-day');
        }
        
        // Ø§Ú¯Ø± Ø±ÙˆØ² Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡ Ø§Ø³Øª
        if (dateStr === selectedDate) {
            dayElement.classList.add('selected-day');
        }
        
        dayElement.addEventListener('click', () => selectDate(dateStr));
        daysGrid.appendChild(dayElement);
    }
    
    // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø±ÙˆØ²Ù‡Ø§ÛŒ Ù…Ø§Ù‡ Ø¨Ø¹Ø¯
    const totalCells = 42;
    const remainingCells = totalCells - (firstDayOfWeek + daysInMonth);
    
    for (let day = 1; day <= remainingCells; day++) {
        const dayElement = document.createElement('div');
        dayElement.className = 'day other-month';
        dayElement.textContent = day;
        daysGrid.appendChild(dayElement);
    }
    
    // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù‡Ø¯Ø± ØªÙ‚ÙˆÛŒÙ…
    document.querySelector('.current-month').textContent = `${persianMonths[month-1]} ${year}`;
}

// Ø§Ù†ØªØ®Ø§Ø¨ ØªØ§Ø±ÛŒØ®
let selectedDate = getCurrentJalaliDate().toString();
let startDate = '';
let endDate = '';

function selectDate(dateStr) {
    selectedDate = dateStr;
    generateCalendar(currentYear, currentMonth);
}

// ØªÙ†Ø¸ÛŒÙ… ØªØ§Ø±ÛŒØ® Ø´Ø±ÙˆØ¹
function setStartDate() {
    startDate = selectedDate;
    document.getElementById('startDate').value = startDate;
    document.getElementById('displayStartDate').textContent = formatPersianDate(startDate);
    updateMonthsFromDates();
}

// ØªÙ†Ø¸ÛŒÙ… ØªØ§Ø±ÛŒØ® Ù¾Ø§ÛŒØ§Ù†
function setEndDate() {
    endDate = selectedDate;
    document.getElementById('endDate').value = endDate;
    document.getElementById('displayEndDate').textContent = formatPersianDate(endDate);
    updateMonthsFromDates();
}

// ÙØ±Ù…Øªâ€ŒØ¨Ù†Ø¯ÛŒ ØªØ§Ø±ÛŒØ® Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´
function formatPersianDate(dateStr) {
    const [y, m, d] = dateStr.split('/').map(Number);
    return `${d} ${persianMonths[m-1]} ${y}`;
}

// Ù…Ø­Ø§Ø³Ø¨Ù‡ ØªØ¹Ø¯Ø§Ø¯ Ù…Ø§Ù‡â€ŒÙ‡Ø§ Ø¨ÛŒÙ† Ø¯Ùˆ ØªØ§Ø±ÛŒØ®
function calculateMonthsBetweenDates(startDate, endDate) {
    const startParts = startDate.split('/').map(Number);
    const endParts = endDate.split('/').map(Number);
    
    const startYear = startParts[0];
    const startMonth = startParts[1];
    const endYear = endParts[0];
    const endMonth = endParts[1];
    
    return (endYear - startYear) * 12 + (endMonth - startMonth) + 1;
}

// Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ØªØ¹Ø¯Ø§Ø¯ Ù…Ø§Ù‡â€ŒÙ‡Ø§ Ø¨Ø± Ø§Ø³Ø§Ø³ ØªØ§Ø±ÛŒØ®â€ŒÙ‡Ø§
function updateMonthsFromDates() {
    if (startDate && endDate) {
        const months = calculateMonthsBetweenDates(startDate, endDate);
        document.getElementById('installmentMonths').value = months;
        document.getElementById('displayMonths').textContent = months;
        
        // Ø¨Ø±Ø±Ø³ÛŒ Ø§ÛŒÙ†Ú©Ù‡ ØªØ§Ø±ÛŒØ® Ù¾Ø§ÛŒØ§Ù† Ø¨Ø¹Ø¯ Ø§Ø² ØªØ§Ø±ÛŒØ® Ø´Ø±ÙˆØ¹ Ø¨Ø§Ø´Ø¯
        const startParts = startDate.split('/').map(Number);
        const endParts = endDate.split('/').map(Number);
        
        if (endParts[0] < startParts[0] || 
            (endParts[0] === startParts[0] && endParts[1] < startParts[1]) ||
            (endParts[0] === startParts[0] && endParts[1] === startParts[1] && endParts[2] < startParts[2])) {
            showNotification('ØªØ§Ø±ÛŒØ® Ù¾Ø§ÛŒØ§Ù† Ø¨Ø§ÛŒØ¯ Ø¨Ø¹Ø¯ Ø§Ø² ØªØ§Ø±ÛŒØ® Ø´Ø±ÙˆØ¹ Ø¨Ø§Ø´Ø¯', 'error');
        }
    }
}

// ÙØ±Ù…Øª Ú©Ø±Ø¯Ù† Ø§Ø¹Ø¯Ø§Ø¯
function formatNumber(num){ return new Intl.NumberFormat('fa-IR').format(num);}

// ØªØ¨Ø¯ÛŒÙ„ Ù…Ø¨Ù„Øº Ø¨Ù‡ Ø¹Ø¯Ø¯
function parseAmount(str){ return parseInt(str.replace(/[^\d]/g,''))||0;}

// Ù†Ù…Ø§ÛŒØ´ Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù†
function showNotification(msg,type='success'){ 
    const n=document.getElementById('notification'); 
    n.textContent=msg; 
    n.style.background=type==='success'?'#40c057':'#fa5252'; 
    n.style.display='block'; 
    setTimeout(()=>{ n.style.display='none'; },3000);
}

// Ù†Ù…Ø§ÛŒØ´ Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† Ø¨Ø§ ØµØ¯Ø§
function showNotificationWithSound(title,body){ 
    const sound=document.getElementById('notifSound'); 
    if("Notification" in window && Notification.permission==="granted"){ 
        for(let i=0;i<5;i++){ 
            new Notification(title,{body:body,icon:"https://cdn-icons-png.flaticon.com/512/190/190411.png"}); 
            sound.play(); 
        } 
    } else { 
        for(let i=0;i<5;i++){ 
            showNotification(`${title}: ${body}`,'error'); 
            sound.play(); 
        } 
    }
}

// Ù…Ø­Ø§Ø³Ø¨Ù‡ ØªØ§Ø±ÛŒØ®â€ŒÙ‡Ø§ÛŒ Ù‚Ø³Ø· Ø¨Ø± Ø§Ø³Ø§Ø³ ØªØ§Ø±ÛŒØ® Ø´Ø±ÙˆØ¹ Ùˆ Ù¾Ø§ÛŒØ§Ù†
function calculateInstallmentDates(startDate, endDate, day){
    const dates=[];
    
    // ØªØ¨Ø¯ÛŒÙ„ ØªØ§Ø±ÛŒØ® Ø´Ø±ÙˆØ¹ Ø¨Ù‡ Ø´Ù…Ø³ÛŒ
    const startParts = startDate.split('/').map(Number);
    const startJy = startParts[0];
    const startJm = startParts[1];
    const startJd = startParts[2];
    
    // ØªØ¨Ø¯ÛŒÙ„ ØªØ§Ø±ÛŒØ® Ù¾Ø§ÛŒØ§Ù† Ø¨Ù‡ Ø´Ù…Ø³ÛŒ
    const endParts = endDate.split('/').map(Number);
    const endJy = endParts[0];
    const endJm = endParts[1];
    const endJd = endParts[2];
    
    // Ù…Ø­Ø§Ø³Ø¨Ù‡ ØªØ¹Ø¯Ø§Ø¯ Ù…Ø§Ù‡â€ŒÙ‡Ø§
    const monthsDiff = (endJy - startJy) * 12 + (endJm - startJm) + 1;
    
    // Ø§ÛŒØ¬Ø§Ø¯ ØªØ§Ø±ÛŒØ®â€ŒÙ‡Ø§ÛŒ Ù‚Ø³Ø·
    for(let i=0; i<monthsDiff; i++){
        let year = startJy;
        let month = startJm + i;
        
        // ØªÙ†Ø¸ÛŒÙ… Ø³Ø§Ù„ Ùˆ Ù…Ø§Ù‡
        while(month > 12){
            month -= 12;
            year += 1;
        }
        
        // ØªÙ†Ø¸ÛŒÙ… Ø±ÙˆØ² Ù‚Ø³Ø·
        let installmentDay = day;
        
        // Ø§Ú¯Ø± Ø±ÙˆØ² Ù‚Ø³Ø· Ø¨ÛŒØ´ØªØ± Ø§Ø² Ø±ÙˆØ²Ù‡Ø§ÛŒ Ù…Ø§Ù‡ Ø¨Ø§Ø´Ø¯ØŒ Ø§Ø² Ø¢Ø®Ø± Ù…Ø§Ù‡ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†
        const daysInMonth = getDaysInJalaliMonth(year, month);
        if(installmentDay > daysInMonth){
            installmentDay = daysInMonth;
        }
        
        const installmentDate = { 
            year: year, 
            month: month, 
            day: installmentDay, 
            dateStr: `${year}/${month}/${installmentDay}`, 
            displayDate: `${installmentDay} ${persianMonths[month-1]} ${year}`, 
            isPaid: false, 
            isOverdue: isDateOverdue(year, month, installmentDay) 
        };
        dates.push(installmentDate);
    }
    
    return dates;
}

// Ø¨Ø±Ø±Ø³ÛŒ ØªØ§Ø±ÛŒØ® Ø³Ø±Ø±Ø³ÛŒØ¯
function isDateOverdue(y,m,d){ 
    const t=getCurrentJalaliDate(); 
    if(y<t.year) return true; 
    if(y===t.year && m<t.month) return true; 
    if(y===t.year && m===t.month && d<t.day) return true; 
    return false;
}

// Ø§ÙØ²ÙˆØ¯Ù† ÙˆØ§Ù…
function addInstallment(){
    const name=document.getElementById('installmentName').value.trim();
    const monthly=parseAmount(document.getElementById('installmentMonthly').value);
    const day=parseInt(document.getElementById('installmentDay').value);
    const startDate=document.getElementById('startDate').value;
    const endDate=document.getElementById('endDate').value;
    const months=parseInt(document.getElementById('installmentMonths').value);
    
    if(!name){ showNotification('Ù„Ø·ÙØ§Ù‹ Ù†Ø§Ù… ÙˆØ§Ù… Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯','error'); return;}
    if(monthly<=0){ showNotification('Ù…Ø¨Ù„Øº Ù‚Ø³Ø· Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª','error'); return;}
    if(day<1 || day>31){ showNotification('Ø±ÙˆØ² Ø³Ø±Ø±Ø³ÛŒØ¯ Û± ØªØ§ Û³Û±','error'); return;}
    if(!startDate){ showNotification('Ù„Ø·ÙØ§Ù‹ ØªØ§Ø±ÛŒØ® Ø´Ø±ÙˆØ¹ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯','error'); return;}
    if(!endDate){ showNotification('Ù„Ø·ÙØ§Ù‹ ØªØ§Ø±ÛŒØ® Ù¾Ø§ÛŒØ§Ù† Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯','error'); return;}
    if(months<1 || months>120){ showNotification('ØªØ¹Ø¯Ø§Ø¯ Ù…Ø§Ù‡â€ŒÙ‡Ø§ Û± ØªØ§ Û±Û²Û°','error'); return;}
    
    // Ø¨Ø±Ø±Ø³ÛŒ Ø§ÛŒÙ†Ú©Ù‡ ØªØ§Ø±ÛŒØ® Ù¾Ø§ÛŒØ§Ù† Ø¨Ø¹Ø¯ Ø§Ø² ØªØ§Ø±ÛŒØ® Ø´Ø±ÙˆØ¹ Ø¨Ø§Ø´Ø¯
    const startParts = startDate.split('/').map(Number);
    const endParts = endDate.split('/').map(Number);
    
    if (endParts[0] < startParts[0] || 
        (endParts[0] === startParts[0] && endParts[1] < startParts[1]) ||
        (endParts[0] === startParts[0] && endParts[1] === startParts[1] && endParts[2] < startParts[2])) {
        showNotification('ØªØ§Ø±ÛŒØ® Ù¾Ø§ÛŒØ§Ù† Ø¨Ø§ÛŒØ¯ Ø¨Ø¹Ø¯ Ø§Ø² ØªØ§Ø±ÛŒØ® Ø´Ø±ÙˆØ¹ Ø¨Ø§Ø´Ø¯','error');
        return;
    }
    
    const installmentDates=calculateInstallmentDates(startDate, endDate, day);
    loans.push({ 
        id:Date.now(), 
        name:name, 
        monthlyAmount:monthly, 
        totalRemainingAmount:monthly*months, 
        day:day, 
        remainingMonths:months, 
        startDate:startDate,
        endDate:endDate,
        dates:installmentDates, 
        createdAt:new Date().toISOString(), 
        isActive:true 
    });
    
    saveLoans(); 
    renderLoans(); 
    updateStats();
    
    // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ÙØ±Ù…
    document.getElementById('installmentName').value=''; 
    document.getElementById('installmentMonthly').value=''; 
    document.getElementById('installmentDay').value=''; 
    document.getElementById('startDate').value=''; 
    document.getElementById('endDate').value=''; 
    document.getElementById('installmentMonths').value='';
    document.getElementById('displayStartDate').textContent = '--';
    document.getElementById('displayEndDate').textContent = '--';
    document.getElementById('displayMonths').textContent = '--';
    
    startDate = '';
    endDate = '';
    
    showNotification('ÙˆØ§Ù… Ø¬Ø¯ÛŒØ¯ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯');
}

// Ø­Ø°Ù ÙˆØ§Ù…
function deleteLoan(id){ 
    if(confirm('Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† ÙˆØ§Ù… Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ')){ 
        loans=loans.filter(l=>l.id!==id); 
        saveLoans(); 
        renderLoans(); 
        updateStats(); 
        showNotification('ÙˆØ§Ù… Ø­Ø°Ù Ø´Ø¯');
    }
}

// Ù¾Ø±Ø¯Ø§Ø®Øª Ù‚Ø³Ø·
function togglePayment(loanId,dateIndex,status){ 
    const loan=loans.find(l=>l.id===loanId); 
    if(loan){ 
        loan.dates[dateIndex].isPaid=status; 
        const unpaidCount=loan.dates.filter(d=>!d.isPaid).length; 
        loan.remainingMonths=unpaidCount; 
        loan.totalRemainingAmount=loan.monthlyAmount*unpaidCount; 
        loan.isActive=unpaidCount>0; 
        saveLoans(); 
        renderLoans(); 
        updateStats(); 
        showNotification(`Ù‚Ø³Ø· ${status?'Ù¾Ø±Ø¯Ø§Ø®Øª Ø´Ø¯':'Ù¾Ø±Ø¯Ø§Ø®Øª Ù†Ø´Ø¯'}`);
    }
}

// Ù†Ù…Ø§ÛŒØ´ ÙˆØ§Ù…â€ŒÙ‡Ø§
function renderLoans(){ 
    const container=document.getElementById('installmentsContainer'); 
    if(loans.length===0){ 
        container.innerHTML=`<div class="empty-state"><i>ğŸ’³</i><h3>Ù‡ÛŒÚ† ÙˆØ§Ù…ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</h3><p>ÙˆØ§Ù… Ø§ÙˆÙ„ Ø®ÙˆØ¯ Ø±Ø§ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒØ¯</p></div>`; 
        return;
    }
    
    container.innerHTML=''; 
    loans.forEach(loan=>{ 
        let installmentsHTML=''; 
        loan.dates.forEach((d,i)=>{ 
            let rowClass=d.isPaid?'paid':d.isOverdue?'overdue':'upcoming'; 
            installmentsHTML+=`
                <div class="installment-row ${rowClass}">
                    <div class="installment-date">${d.displayDate}</div>
                    <div class="installment-amount">${formatNumber(loan.monthlyAmount)}</div>
                    <div class="payment-buttons">
                        <button class="pay-btn ${d.isPaid?'paid':'unpaid'}" onclick="togglePayment(${loan.id},${i},${!d.isPaid})">
                            ${d.isPaid?'Ù¾Ø±Ø¯Ø§Ø®Øª Ø´Ø¯':'Ù¾Ø±Ø¯Ø§Ø®Øª Ù†Ø´Ø¯Ù‡'}
                        </button>
                    </div>
                </div>
            `;
        }); 
        
        // ØªØ¨Ø¯ÛŒÙ„ ØªØ§Ø±ÛŒØ® Ø´Ø±ÙˆØ¹ Ùˆ Ù¾Ø§ÛŒØ§Ù† Ø¨Ù‡ Ø´Ù…Ø³ÛŒ
        const startParts = loan.startDate.split('/').map(Number);
        const endParts = loan.endDate.split('/').map(Number);
        
        const startDateStr = `${startParts[2]} ${persianMonths[startParts[1]-1]} ${startParts[0]}`;
        const endDateStr = `${endParts[2]} ${persianMonths[endParts[1]-1]} ${endParts[0]}`;
        
        container.innerHTML+=`
            <div class="loan-card">
                <div class="loan-header">
                    <div class="loan-title">${loan.name}</div>
                    <div class="loan-amount">${formatNumber(loan.totalRemainingAmount)}</div>
                </div>
                <div class="loan-details">
                    <div class="detail-item">
                        <div class="detail-label">Ú©Ù„ Ù‚Ø³Ø·â€ŒÙ‡Ø§</div>
                        <div class="detail-value">${loan.dates.length}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Ù…Ø§Ù†Ø¯Ù‡</div>
                        <div class="detail-value">${loan.remainingMonths}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">ØªØ§Ø±ÛŒØ® Ù¾Ø§ÛŒØ§Ù†</div>
                        <div class="detail-value">${endDateStr}</div>
                    </div>
                </div>
                <div class="installments-list">${installmentsHTML}</div>
                <div class="loan-actions">
                    <span class="loan-status ${loan.isActive?'status-active':'status-completed'}">
                        ${loan.isActive?'ÙØ¹Ø§Ù„':'Ø§ØªÙ…Ø§Ù…'}
                    </span>
                    <button class="delete-btn" onclick="deleteLoan(${loan.id})">Ø­Ø°Ù ÙˆØ§Ù…</button>
                </div>
            </div>
        `; 
    });
}

// Ù…Ø¯ÛŒØ±ÛŒØª Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
function saveLoans(){ localStorage.setItem('loans',JSON.stringify(loans)); }

function exportData(){ 
    const dataStr="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(loans)); 
    const dlAnchor=document.createElement('a'); 
    dlAnchor.setAttribute("href",dataStr); 
    dlAnchor.setAttribute("download","loans.json"); 
    dlAnchor.click();
}

function importData(event){ 
    const file=event.target.files[0]; 
    const reader=new FileReader(); 
    reader.onload=function(e){ 
        try{ 
            loans=JSON.parse(e.target.result); 
            saveLoans(); 
            renderLoans(); 
            updateStats(); 
            showNotification('Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ ÙˆØ§Ø±Ø¯ Ø´Ø¯Ù†Ø¯'); 
        }catch(err){ 
            showNotification('Ø®Ø·Ø§ Ø¯Ø± ÙˆØ§Ø±Ø¯ Ú©Ø±Ø¯Ù† ÙØ§ÛŒÙ„','error'); 
        }
    }; 
    reader.readAsText(file);
}

function clearAllData(){ 
    if(confirm('Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ Ù‡Ù…Ù‡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø­Ø°Ù Ø´ÙˆÙ†Ø¯ØŸ')){ 
        loans=[]; 
        saveLoans(); 
        renderLoans(); 
        updateStats(); 
        showNotification('Ù‡Ù…Ù‡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø­Ø°Ù Ø´Ø¯Ù†Ø¯'); 
    }
}

// Ø¢Ù…Ø§Ø±
function updateStats(){ 
    const totalLoans=loans.length; 
    let upcomingCount=0; 
    let overdueCount=0; 
    let totalRemaining=0; 
    
    loans.forEach(loan=>{ 
        loan.dates.forEach(d=>{ 
            if(!d.isPaid){ 
                const t=getCurrentJalaliDate(); 
                if(d.year>t.year||(d.year===t.year && d.month>t.month)||(d.year===t.year && d.month===t.month && d.day>=t.day)) 
                    upcomingCount++; 
                if(d.isOverdue && !d.isPaid) 
                    overdueCount++; 
                totalRemaining+=loan.monthlyAmount; 
            } 
        });
    }); 
    
    document.getElementById('totalLoans').textContent=totalLoans; 
    document.getElementById('upcomingCount').textContent=upcomingCount; 
    document.getElementById('overdueCount').textContent=overdueCount; 
    document.getElementById('totalRemaining').textContent=formatNumber(totalRemaining);
}

// Ø¨Ø±Ø±Ø³ÛŒ Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† Ù‚Ø³Ø·â€ŒÙ‡Ø§
function checkInstallmentNotifications(){
    const today=getCurrentJalaliDate();
    const tomorrowDate=new Date(); 
    tomorrowDate.setDate(tomorrowDate.getDate()+1);
    
    // Ù…Ø­Ø§Ø³Ø¨Ù‡ ØªØ§Ø±ÛŒØ® ÙØ±Ø¯Ø§ Ø¨Ù‡ Ø´Ù…Ø³ÛŒ
    const tomorrowJalali = getCurrentJalaliDate();
    tomorrowJalali.day += 1;
    if (tomorrowJalali.day > getDaysInJalaliMonth(tomorrowJalali.year, tomorrowJalali.month)) {
        tomorrowJalali.day = 1;
        tomorrowJalali.month += 1;
        if (tomorrowJalali.month > 12) {
            tomorrowJalali.month = 1;
            tomorrowJalali.year += 1;
        }
    }
    
    loans.forEach(loan=>{
        loan.dates.forEach(date=>{
            if(!date.isPaid){
                if(date.year===today.year && date.month===today.month && date.day===today.day){
                    showNotificationWithSound(`ğŸ’³ Ù‚Ø³Ø· Ø§Ù…Ø±ÙˆØ²: ${loan.name}`,`Ù…Ø¨Ù„Øº: ${formatNumber(loan.monthlyAmount)} ØªÙˆÙ…Ø§Ù†`);
                }
                if(date.year===tomorrowJalali.year && date.month===tomorrowJalali.month && date.day===tomorrowJalali.day){
                    showNotificationWithSound(`ğŸ’³ Ù‚Ø³Ø· ÙØ±Ø¯Ø§: ${loan.name}`,`Ù…Ø¨Ù„Øº: ${formatNumber(loan.monthlyAmount)} ØªÙˆÙ…Ø§Ù†`);
                }
            }
        });
    });
}

// Ø¯Ú©Ù…Ù‡ ØªØ³Øª Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù†
function testNotificationCheckDue(){
    const today=getCurrentJalaliDate();
    const tomorrowDate=new Date(); 
    tomorrowDate.setDate(tomorrowDate.getDate()+1);
    
    // Ù…Ø­Ø§Ø³Ø¨Ù‡ ØªØ§Ø±ÛŒØ® ÙØ±Ø¯Ø§ Ø¨Ù‡ Ø´Ù…Ø³ÛŒ
    const tomorrowJalali = getCurrentJalaliDate();
    tomorrowJalali.day += 1;
    if (tomorrowJalali.day > getDaysInJalaliMonth(tomorrowJalali.year, tomorrowJalali.month)) {
        tomorrowJalali.day = 1;
        tomorrowJalali.month += 1;
        if (tomorrowJalali.month > 12) {
            tomorrowJalali.month = 1;
            tomorrowJalali.year += 1;
        }
    }
    
    let hasDue=false;
    
    loans.forEach(loan=>{
        loan.dates.forEach(date=>{
            if(!date.isPaid){
                if((date.year===today.year && date.month===today.month && date.day===today.day) ||
                   (date.year===tomorrowJalali.year && date.month===tomorrowJalali.month && date.day===tomorrowJalali.day)){
                    hasDue=true;
                    showNotificationWithSound(`ğŸ’³ Ù…ÙˆØ¹Ø¯ Ù‚Ø³Ø·: ${loan.name}`,`Ù…Ø¨Ù„Øº: ${formatNumber(loan.monthlyAmount)} ØªÙˆÙ…Ø§Ù†`);
                }
            }
        });
    });
    
    if(!hasDue){
        showNotificationWithSound('ğŸ’³ Ù‡ÛŒÚ† Ù‚Ø³Ø·ÛŒ Ø§Ù…Ø±ÙˆØ² ÛŒØ§ ÙØ±Ø¯Ø§ Ù†ÛŒØ³Øª','Ù…ÙˆØ¹Ø¯ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯');
    }
}

// Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø§ÙˆÙ„ÛŒÙ‡
document.addEventListener('DOMContentLoaded', () => {
    // Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² ØªØ§Ø±ÛŒØ® Ø¬Ø§Ø±ÛŒ Ø¨Ù‡ Ø¬Ø§ÛŒ ØªØ§Ø±ÛŒØ® Ø«Ø§Ø¨Øª
    const currentJalali = getCurrentJalaliDate();
    let currentYear = currentJalali.year;
    let currentMonth = currentJalali.month;
    
    // ØªÙˆÙ„ÛŒØ¯ ØªÙ‚ÙˆÛŒÙ…
    generateCalendar(currentYear, currentMonth);
    
    // Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ÛŒ Ù†Ø§ÙˆØ¨Ø±ÛŒ ØªÙ‚ÙˆÛŒÙ…
    document.querySelector('.prev-year').addEventListener('click', () => {
        currentYear--;
        generateCalendar(currentYear, currentMonth);
    });
    
    document.querySelector('.prev-month').addEventListener('click', () => {
        currentMonth--;
        if (currentMonth < 1) {
            currentMonth = 12;
            currentYear--;
        }
        generateCalendar(currentYear, currentMonth);
    });
    
    document.querySelector('.next-month').addEventListener('click', () => {
        currentMonth++;
        if (currentMonth > 12) {
            currentMonth = 1;
            currentYear++;
        }
        generateCalendar(currentYear, currentMonth);
    });
    
    document.querySelector('.next-year').addEventListener('click', () => {
        currentYear++;
        generateCalendar(currentYear, currentMonth);
    });
    
    // Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ ØªØ§Ø±ÛŒØ®
    document.getElementById('setStartDate').addEventListener('click', setStartDate);
    document.getElementById('setEndDate').addEventListener('click', setEndDate);
    
    // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§ÙˆÙ„ÛŒÙ‡
    renderLoans();
    updateStats();
});

// Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¯Ø³ØªØ±Ø³ÛŒ Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù†
if("Notification" in window && Notification.permission!=="granted"){ 
    Notification.requestPermission(); 
}

// Ø¨Ø±Ø±Ø³ÛŒ Ù‡Ø± Û³Û° Ø¯Ù‚ÛŒÙ‚Ù‡
setInterval(checkInstallmentNotifications,30*60*1000);
</script>
</body>
</html>
